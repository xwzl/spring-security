<div class="article-entry" itemprop="articleBody">

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡æ¥ <a href="http://svip.iocoder.cn/Spring-Boot/ServletWebServerApplicationContext">ã€Šç²¾å°½ Spring Boot æºç åˆ†æ â€”â€” ServletWebServerApplicationContextã€‹</a> ä¸€æ–‡ï¼Œæˆ‘ä»¬æ¥åˆ†äº« ReactiveWebServerApplicationContext ç±»ï¼Œå®ƒæä¾› Reactive Web ç¯å¢ƒçš„ Spring å®¹å™¨ã€‚</p>
<p>AnnotationConfigReactiveWebServerApplicationContext çš„ç±»å›¾å…³ç³»å¦‚ä¸‹ï¼š<img src="http://static2.iocoder.cn/images/Spring-Boot/2021-01-19/01.jpg" alt="ç±»å›¾"></p>
<ul>
<li>ç›¸æ¯”æ¥è¯´ï¼ŒReactiveWebServerApplicationContext æ¯” ServletWebServerApplicationContext æœ‰æ›´å¤šçš„å±‚çº§å…³ç³»ã€‚ä¸è¿‡æ²¡äº‹ï¼Œæˆ‘ä»¬ä¸€ç‚¹ä¸€ç‚¹æ¥çœ‹ã€‚</li>
</ul>
<blockquote>
<p>è‰¿è‰¿ï¼šSpring Webflux ï¼Œæˆ‘è‡ªå·±ç›®å‰æ²¡å¤ªä½¿ç”¨è¿‡ã€‚çœ‹è¿™å—ï¼Œå°±å•çº¯å¥½å¥‡ä¸‹ï¼Œå“ˆå“ˆå“ˆã€‚</p>
</blockquote>
<h1 id="2-ReactiveWebApplicationContext"><a href="#2-ReactiveWebApplicationContext" class="headerlink" title="2. ReactiveWebApplicationContext"></a>2. ReactiveWebApplicationContext</h1><p><code>org.springframework.boot.web.reactive.context.ReactiveWebApplicationContext</code> ï¼Œç»§æ‰¿ ApplicationContext æ¥å£ï¼ŒReactive Web ApplicationContext æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ReactiveWebApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ReactiveWebApplicationContext</span> <span class="keyword">extends</span> <span class="title">ApplicationContext</span> </span>{</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="3-ConfigurableReactiveWebApplicationContext"><a href="#3-ConfigurableReactiveWebApplicationContext" class="headerlink" title="3. ConfigurableReactiveWebApplicationContext"></a>3. ConfigurableReactiveWebApplicationContext</h1><p><code>org.springframework.boot.web.reactive.context.ConfigurableReactiveWebApplicationContext</code> ï¼Œç»§æ‰¿ ConfigurableApplicationContextã€<a href="#">ã€Œ2. ReactiveWebApplicationContextã€</a> æ¥å£ï¼Œå¯é…ç½®çš„ ReactiveWebApplicationContext æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ReactiveWebApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConfigurableReactiveWebApplicationContext</span> <span class="keyword">extends</span> <span class="title">ConfigurableApplicationContext</span>, <span class="title">ReactiveWebApplicationContext</span> </span>{</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="4-GenericReactiveWebApplicationContext"><a href="#4-GenericReactiveWebApplicationContext" class="headerlink" title="4. GenericReactiveWebApplicationContext"></a>4. GenericReactiveWebApplicationContext</h1><p><code>org.springframework.boot.web.reactive.context.GenericReactiveWebApplicationContext</code> ï¼Œå®ç° <a href="#">ã€Œ3. ConfigurableReactiveWebApplicationContextã€</a> æ¥å£ï¼Œç»§æ‰¿ GenericApplicationContext ç±»ï¼Œé€šç”¨çš„ Reactive Web ApplicationContext å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// GenericReactiveWebApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericReactiveWebApplicationContext</span> <span class="keyword">extends</span> <span class="title">GenericApplicationContext</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">ConfigurableReactiveWebApplicationContext</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GenericReactiveWebApplicationContext</span><span class="params">()</span> </span>{</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GenericReactiveWebApplicationContext</span><span class="params">(DefaultListableBeanFactory beanFactory)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(beanFactory);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// è¦†å†™ AbstractApplicationContext æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ConfigurableEnvironment <span class="title">createEnvironment</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StandardReactiveWebEnvironment(); <span class="comment">// &lt;X&gt;</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// è¦†å†™ AbstractApplicationContext æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Resource <span class="title">getResourceByPath</span><span class="params">(String path)</span> </span>{</span><br><span class="line">        <span class="comment">// We must be careful not to expose classpath resources</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FilteredReactiveWebContextResource(path); <span class="comment">// &lt;Y&gt;</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é‡ç‚¹åœ¨ <code>&lt;X&gt;</code> å’Œ <code>&lt;Y&gt;</code> å¤„ï¼Œè¦†å†™äº†æ–¹æ³•ï¼Œåˆ†åˆ«è¿”å›äº† StandardReactiveWebEnvironment å’Œ FilteredReactiveWebContextResource å¯¹è±¡ã€‚ä¸è¿‡çœ‹äº†ä¸‹è¿™ä¸¤ä¸ªå¯¹è±¡ï¼Œæš‚æ—¶ä¹Ÿæ²¡ä»€ä¹ˆç‰¹æ®Šçš„æ–¹æ³•ã€‚æ‰€ä»¥ï¼Œå¯æš‚æ—¶å¿½ç•¥~</li>
</ul>
<h1 id="5-ReactiveWebServerApplicationContext"><a href="#5-ReactiveWebServerApplicationContext" class="headerlink" title="5. ReactiveWebServerApplicationContext"></a>5. ReactiveWebServerApplicationContext</h1><blockquote>
<p>è‰¿è‰¿ï¼šæ­£æˆå¼€å§‹~</p>
</blockquote>
<p><code>org.springframework.boot.web.reactive.context.ReactiveWebServerApplicationContext</code> ï¼Œå®ç° ConfigurableWebServerApplicationContext æ¥å£ï¼Œç»§æ‰¿ GenericReactiveWebApplicationContext ç±»ï¼ŒSpring Boot ä½¿ç”¨ Reactive Web æœåŠ¡å™¨çš„ ApplicationContext å®ç°ç±»ã€‚</p>
<h2 id="5-1-æ„é€ æ–¹æ³•"><a href="#5-1-æ„é€ æ–¹æ³•" class="headerlink" title="5.1 æ„é€ æ–¹æ³•"></a>5.1 æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ServerManager å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> ServerManager serverManager;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€šè¿‡ {<span class="doctag">@link</span> #setServerNamespace(String)} æ³¨å…¥ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ä¸è¿‡è²Œä¼¼ï¼Œä¸€ç›´æ²¡è¢«æ³¨å…¥è¿‡ï¼Œå¯ä»¥æš‚æ—¶å…ˆæ— è§†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String serverNamespace;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReactiveWebServerApplicationContext</span><span class="params">()</span> </span>{</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReactiveWebServerApplicationContext</span><span class="params">(DefaultListableBeanFactory beanFactory)</span> </span>{</span><br><span class="line">    <span class="keyword">super</span>(beanFactory);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>serverManager</code> å±æ€§ï¼ŒServerManager å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ5.2 ServerManagerã€</a> ã€‚</li>
</ul>
<h2 id="5-2-ServerManager"><a href="#5-2-ServerManager" class="headerlink" title="5.2 ServerManager"></a>5.2 ServerManager</h2><p>ServerManager æ˜¯ ReactiveWebServerApplicationContext çš„å†…éƒ¨é™æ€ç±»ï¼Œå®ç° <code>org.springframework.http.server.reactive.HttpHandler</code> æ¥å£ï¼Œå†…å« Server çš„ç®¡ç†å™¨ã€‚</p>
<h3 id="5-2-1-æ„é€ æ–¹æ³•"><a href="#5-2-1-æ„é€ æ–¹æ³•" class="headerlink" title="5.2.1 æ„é€ æ–¹æ³•"></a>5.2.1 æ„é€ æ–¹æ³•</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext#ServerManager.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WebServer å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> WebServer server;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * HttpHandler å¯¹è±¡ï¼Œå…·ä½“åœ¨ {<span class="doctag">@link</span> #handle(ServerHttpRequest, ServerHttpResponse)} æ–¹æ³•ä¸­ä½¿ç”¨ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> HttpHandler handler;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">ServerManager</span><span class="params">(ReactiveWebServerFactory factory)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.handler = <span class="keyword">this</span>::handleUninitialized; <span class="comment">// &lt;1&gt; åŒä¸‹é¢</span></span><br><span class="line"><span class="comment">//          this.handler = new HttpHandler() {</span></span><br><span class="line"><span class="comment">//                @Override</span></span><br><span class="line"><span class="comment">//                public Mono&lt;Void&gt; handle(ServerHttpRequest request, ServerHttpResponse response) {</span></span><br><span class="line"><span class="comment">//                    return handleUninitialized(request, response);</span></span><br><span class="line"><span class="comment">//                }</span></span><br><span class="line"><span class="comment">//            };</span></span><br><span class="line">    <span class="keyword">this</span>.server = factory.getWebServer(<span class="keyword">this</span>); <span class="comment">// &lt;2&gt;</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Mono&lt;Void&gt; <span class="title">handleUninitialized</span><span class="params">(ServerHttpRequest request, ServerHttpResponse response)</span> </span>{</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The HttpHandler has not yet been initialized"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œåˆ›å»ºçš„ <code>handler</code> å¯¹è±¡ï¼Œå†…éƒ¨å®ç°è°ƒç”¨äº† <code>#handleUninitialized(ServerHttpRequest request, ServerHttpResponse response)</code> æ–¹æ³•ï¼Œä¼šæŠ›å‡º IllegalStateException å¼‚å¸¸ã€‚è¡¨ç¤ºï¼Œæ­¤æ—¶è¯¥ <code>server</code> è¿˜ä¸å¯ç”¨ã€‚å› ä¸ºï¼Œ<code>server</code> éƒ½è¿˜æ²¡å¯åŠ¨ã€‚ğŸ˜ˆ </li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>ReactiveWebServerFactory#getWebServer(HttpHandler handler)</code> æ–¹æ³•ï¼Œåˆ›å»º WebServer å¯¹è±¡ã€‚å…¶ä¸­ï¼Œæ–¹æ³•å‚æ•° <code>handler</code> ä¼ é€’æ˜¯ <code>this</code> è‡ªå·±ï¼Œå› ä¸ºåé¢çš„è¯·æ±‚å¤„ç†çš„ <code>#handle(ServerHttpRequest request, ServerHttpResponse)</code> æ–¹æ³•ï¼Œéœ€è¦è°ƒç”¨è‡ªå·±å“Ÿã€‚</li>
</ul>
<h3 id="5-2-2-handle"><a href="#5-2-2-handle" class="headerlink" title="5.2.2 handle"></a>5.2.2 handle</h3><p>å®ç° <code>#handle(ServerHttpRequest request, ServerHttpResponse)</code> æ–¹æ³•ï¼Œå¤„ç†è¯·æ±‚ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext#ServerManager.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(ServerHttpRequest request, ServerHttpResponse response)</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.handler.handle(request, response);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å§”æ‰˜ç»™ <code>handler</code> å±æ€§ï¼Œå¯¹åº”çš„æ–¹æ³•ï¼Œå¤„ç†è¯·æ±‚ã€‚</li>
</ul>
<h3 id="5-2-3-get"><a href="#5-2-3-get" class="headerlink" title="5.2.3 get"></a>5.2.3 get</h3><p><code>#get(ReactiveWebServerFactory factory)</code> <strong>é™æ€</strong>æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ª ServerManager å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext#ServerManager.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ServerManager <span class="title">get</span><span class="params">(ReactiveWebServerFactory factory)</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> ServerManager(factory);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="5-2-4-getWebServer"><a href="#5-2-4-getWebServer" class="headerlink" title="5.2.4 getWebServer"></a>5.2.4 getWebServer</h3><p><code>#getWebServer(ServerManager manager)</code> <strong>é™æ€</strong>æ–¹æ³•ï¼Œè·å¾— <code>manager</code> çš„ WebServer å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext#ServerManager.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> WebServer <span class="title">getWebServer</span><span class="params">(ServerManager manager)</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> (manager != <span class="keyword">null</span>) ? manager.server : <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="5-2-5-start"><a href="#5-2-5-start" class="headerlink" title="5.2.5 start"></a>5.2.5 start</h3><p><code>#start(ServerManager manager, Supplier&lt;HttpHandler&gt; handlerSupplier)</code> <strong>é™æ€</strong>æ–¹æ³•ï¼Œå¯åŠ¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext#ServerManager.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(ServerManager manager, Supplier&lt;HttpHandler&gt; handlerSupplier)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (manager != <span class="keyword">null</span> &amp;&amp; manager.server != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="comment">// &lt;1&gt; èµ‹å€¼ handler</span></span><br><span class="line">        manager.handler = handlerSupplier.get();</span><br><span class="line">        <span class="comment">// &lt;2&gt; å¯åŠ¨ server</span></span><br><span class="line">        manager.server.start();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œå°† <code>handlerSupplier</code> èµ‹å€¼ç»™ <code>manager.handler</code> ã€‚</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>WebServer#start()</code> æ–¹æ³•ï¼Œå¯åŠ¨ Server ã€‚</li>
</ul>
<h3 id="5-2-6-stop"><a href="#5-2-6-stop" class="headerlink" title="5.2.6 stop"></a>5.2.6 stop</h3><p><code>#stop(ServerManager manager)</code> <strong>é™æ€</strong>æ–¹æ³•ï¼Œåœæ­¢ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext#ServerManager.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">(ServerManager manager)</span> </span>{</span><br><span class="line">	<span class="keyword">if</span> (manager != <span class="keyword">null</span> &amp;&amp; manager.server != <span class="keyword">null</span>) {</span><br><span class="line">		<span class="keyword">try</span> {</span><br><span class="line">			manager.server.stop();</span><br><span class="line">		} <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è°ƒç”¨ <code>ServerManager#stop()</code> æ–¹æ³•ï¼Œåœæ­¢ Server ã€‚</li>
</ul>
<blockquote>
<p>ğŸ˜ˆ åˆ°æ­¤æ—¶ï¼Œå¯èƒ½èƒ–å‹æœ‰ç‚¹æ‡µé€¼ã€‚æ²¡äº‹ï¼Œæˆ‘ä»¬ä¸‹é¢çœ‹çœ‹ ReactiveWebServerApplicationContext æ€ä¹ˆä½¿ç”¨å®ƒã€‚</p>
</blockquote>
<h2 id="5-3-refresh"><a href="#5-3-refresh" class="headerlink" title="5.3 refresh"></a>5.3 refresh</h2><p>è¦†å†™ <code>#refresh()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– Spring å®¹å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// è°ƒç”¨çˆ¶æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">super</span>.refresh();</span><br><span class="line">    } <span class="keyword">catch</span> (RuntimeException ex) {</span><br><span class="line">        <span class="comment">// &lt;X&gt; åœæ­¢ Reactive WebServer</span></span><br><span class="line">        stopAndReleaseReactiveWebServer();</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä¸»è¦æ˜¯ <code>&lt;X&gt;</code> å¤„ï¼Œå¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™è°ƒç”¨ <code>#stopAndReleaseWebServer()</code> æ–¹æ³•ï¼Œåœæ­¢ WebServerã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ5.3.1 stopAndReleaseWebServerã€</a> ã€‚</li>
</ul>
<h3 id="5-3-1-stopAndReleaseWebServer"><a href="#5-3-1-stopAndReleaseWebServer" class="headerlink" title="5.3.1 stopAndReleaseWebServer"></a>5.3.1 stopAndReleaseWebServer</h3><p><code>#stopAndReleaseWebServer()</code> æ–¹æ³•ï¼Œåœæ­¢ WebServerã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stopAndReleaseReactiveWebServer</span><span class="params">()</span> </span>{</span><br><span class="line">	ServerManager serverManager = <span class="keyword">this</span>.serverManager;</span><br><span class="line">	<span class="keyword">try</span> {</span><br><span class="line">		ServerManager.stop(serverManager); <span class="comment">// &lt;Y&gt;</span></span><br><span class="line">	} <span class="keyword">finally</span> {</span><br><span class="line">		<span class="keyword">this</span>.serverManager = <span class="keyword">null</span>;</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;Y&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>ServerManager#stop(serverManager)</code> æ–¹æ³•ï¼Œåœæ­¢ WebServer ã€‚</li>
</ul>
<h2 id="5-4-onRefresh"><a href="#5-4-onRefresh" class="headerlink" title="5.4 onRefresh"></a>5.4 onRefresh</h2><p>è¦†å†™ <code>#onRefresh()</code> æ–¹æ³•ï¼Œåœ¨å®¹å™¨åˆå§‹åŒ–æ—¶ï¼Œå®Œæˆ WebServer çš„åˆ›å»ºï¼ˆä¸åŒ…æ‹¬å¯åŠ¨ï¼‰ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; è°ƒç”¨çˆ¶æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">super</span>.onRefresh();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// &lt;2&gt; åˆ›å»º WebServer</span></span><br><span class="line">        createWebServer();</span><br><span class="line">    } <span class="keyword">catch</span> (Throwable ex) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"Unable to start reactive web server"</span>, ex);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨çˆ¶ <code>#onRefresh()</code> æ–¹æ³•ï¼Œæ‰§è¡Œçˆ¶é€»è¾‘ã€‚è¿™å—ï¼Œæš‚æ—¶ä¸ç”¨äº†è§£ã€‚</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#createWebServer()</code> æ–¹æ³•ï¼Œåˆ›å»º WebServer å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ5.4.1 createWebServerã€</a> ã€‚</li>
</ul>
<h3 id="5-4-1-createWebServer"><a href="#5-4-1-createWebServer" class="headerlink" title="5.4.1 createWebServer"></a>5.4.1 createWebServer</h3><p><code>#createWebServer()</code> æ–¹æ³•ï¼Œåˆ›å»º WebServer å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createWebServer</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="comment">// è·å¾— ServerManager å¯¹è±¡ã€‚</span></span><br><span class="line">	ServerManager serverManager = <span class="keyword">this</span>.serverManager;</span><br><span class="line">	<span class="comment">// å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">	<span class="keyword">if</span> (serverManager == <span class="keyword">null</span>) {</span><br><span class="line">		<span class="keyword">this</span>.serverManager = ServerManager.get(getWebServerFactory()); <span class="comment">// &lt;1&gt;</span></span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// &lt;2&gt; åˆå§‹åŒ– PropertySource</span></span><br><span class="line">	initPropertySources();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p><code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#getWebServerFactory()</code> æ–¹æ³•ï¼Œè·å¾— ReactiveWebServerFactory å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> ReactiveWebServerFactory <span class="title">getWebServerFactory</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// Use bean names so that we don't consider the hierarchy</span></span><br><span class="line">    <span class="comment">// è·å¾— ServletWebServerFactory ç±»å‹å¯¹åº”çš„ Bean çš„åå­—ä»¬</span></span><br><span class="line">    String[] beanNames = getBeanFactory().getBeanNamesForType(ReactiveWebServerFactory.class);</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ 0 ä¸ªï¼ŒæŠ›å‡º ApplicationContextException å¼‚å¸¸ï¼Œå› ä¸ºè‡³å°‘è¦ä¸€ä¸ª</span></span><br><span class="line">    <span class="keyword">if</span> (beanNames.length == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"Unable to start ReactiveWebApplicationContext due to missing "</span> + <span class="string">"ReactiveWebServerFactory bean."</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ &gt; 1 ä¸ªï¼ŒæŠ›å‡º ApplicationContextException å¼‚å¸¸ï¼Œå› ä¸ºä¸çŸ¥é“åˆå§‹åŒ–å“ªä¸ª</span></span><br><span class="line">    <span class="keyword">if</span> (beanNames.length &gt; <span class="number">1</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"Unable to start ReactiveWebApplicationContext due to multiple "</span></span><br><span class="line">                        + <span class="string">"ReactiveWebServerFactory beans : "</span> + StringUtils.arrayToCommaDelimitedString(beanNames));</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// è·å¾— ReactiveWebServerFactory ç±»å‹å¯¹åº”çš„ Bean å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> getBeanFactory().getBean(beanNames[<span class="number">0</span>], ReactiveWebServerFactory.class);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ­¤å¤„è¿”å›çš„ä¼šæ˜¯ <code>org.springframework.boot.web.embedded.netty.NettyReactiveWebServerFactory</code> å¯¹è±¡ã€‚</li>
<li>åœ¨æˆ‘ä»¬å¼•å…¥ <code>spring-boot-starter-webflux</code> ä¾èµ–æ—¶ï¼Œ<code>org.springframework.boot.autoconfigure.web.reactive.ReactiveWebServerFactoryConfiguration</code> åœ¨è‡ªåŠ¨é…ç½®æ—¶ï¼Œä¼šé…ç½®å‡º NettyReactiveWebServerFactory Bean å¯¹è±¡ã€‚å› æ­¤ï¼Œæ­¤æ—¶ä¼šè·å¾— NettyReactiveWebServerFactory å¯¹è±¡ã€‚</li>
</ul>
</li>
<li><p><code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>ServerManager#get(ReactiveWebServerFactory)</code> <strong>é™æ€</strong>æ–¹æ³•ï¼Œåˆ›å»º ServerManager å¯¹è±¡ã€‚</p>
</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œè°ƒç”¨çˆ¶ <code>#initPropertySources()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– PropertySource ã€‚</li>
</ul>
<h2 id="5-5-finishRefresh"><a href="#5-5-finishRefresh" class="headerlink" title="5.5 finishRefresh"></a>5.5 finishRefresh</h2><p>è¦†å†™ <code>#finishRefresh()</code> æ–¹æ³•ï¼Œåœ¨å®¹å™¨åˆå§‹åŒ–å®Œæˆæ—¶ï¼Œå¯åŠ¨ WebServer ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishRefresh</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; è°ƒç”¨çˆ¶æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">super</span>.finishRefresh();</span><br><span class="line">    <span class="comment">// &lt;2&gt; å¯åŠ¨ WebServer</span></span><br><span class="line">    WebServer webServer = startReactiveWebServer();</span><br><span class="line">    <span class="comment">// &lt;3&gt; å¦‚æœåˆ›å»º WebServer æˆåŠŸï¼Œå‘å¸ƒ ReactiveWebServerInitializedEvent äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (webServer != <span class="keyword">null</span>) {</span><br><span class="line">        publishEvent(<span class="keyword">new</span> ReactiveWebServerInitializedEvent(webServer, <span class="keyword">this</span>));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#finishRefresh()</code> æ–¹æ³•ï¼Œæ‰§è¡Œçˆ¶é€»è¾‘ã€‚è¿™å—ï¼Œæš‚æ—¶ä¸ç”¨äº†è§£ã€‚</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#startReactiveWebServer()</code> æ–¹æ³•ï¼Œå¯åŠ¨ WebServer ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ5.5.1 startReactiveWebServerã€</a> ã€‚</li>
<li><code>&lt;3&gt;</code> å¤„ï¼Œå¦‚æœåˆ›å»º WebServer æˆåŠŸï¼Œå‘å¸ƒ ReactiveWebServerInitializedEvent äº‹ä»¶ã€‚</li>
</ul>
<h3 id="5-5-1-startReactiveWebServer"><a href="#5-5-1-startReactiveWebServer" class="headerlink" title="5.5.1 startReactiveWebServer"></a>5.5.1 startReactiveWebServer</h3><p><code>#startReactiveWebServer()</code> æ–¹æ³•ï¼Œå¯åŠ¨ WebServer ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> WebServer <span class="title">startReactiveWebServer</span><span class="params">()</span> </span>{</span><br><span class="line">    ServerManager serverManager = <span class="keyword">this</span>.serverManager;</span><br><span class="line">    <span class="comment">// &lt;1&gt; è·å¾— HttpHandler</span></span><br><span class="line">    <span class="comment">// &lt;2&gt; å¯åŠ¨ WebServer</span></span><br><span class="line">    ServerManager.start(serverManager, <span class="keyword">this</span>::getHttpHandler);</span><br><span class="line">    <span class="comment">// &lt;3&gt; è·å¾— WebServer</span></span><br><span class="line">    <span class="keyword">return</span> ServerManager.getWebServer(serverManager);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p><code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#getHttpHandler()</code> æ–¹æ³•ï¼Œè·å¾— HttpHandler å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> HttpHandler <span class="title">getHttpHandler</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// Use bean names so that we don't consider the hierarchy</span></span><br><span class="line">    <span class="comment">// è·å¾— HttpHandler ç±»å‹å¯¹åº”çš„ Bean çš„åå­—ä»¬</span></span><br><span class="line">    String[] beanNames = getBeanFactory().getBeanNamesForType(HttpHandler.class);</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ 0 ä¸ªï¼ŒæŠ›å‡º ApplicationContextException å¼‚å¸¸ï¼Œå› ä¸ºè‡³å°‘è¦ä¸€ä¸ª</span></span><br><span class="line">    <span class="keyword">if</span> (beanNames.length == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"Unable to start ReactiveWebApplicationContext due to missing HttpHandler bean."</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ &gt; 1 ä¸ªï¼ŒæŠ›å‡º ApplicationContextException å¼‚å¸¸ï¼Œå› ä¸ºä¸çŸ¥é“åˆå§‹åŒ–å“ªä¸ª</span></span><br><span class="line">    <span class="keyword">if</span> (beanNames.length &gt; <span class="number">1</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"Unable to start ReactiveWebApplicationContext due to multiple HttpHandler beans : "</span></span><br><span class="line">                        + StringUtils.arrayToCommaDelimitedString(beanNames));</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// è·å¾— HttpHandler ç±»å‹å¯¹åº”çš„ Bean å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> getBeanFactory().getBean(beanNames[<span class="number">0</span>], HttpHandler.class);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿”å›çš„ç»“æœï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://static2.iocoder.cn/images/Spring-Boot/2021-01-19/02.jpg" alt="ç¤ºä¾‹"></li>
<li>è¯¥ HttpHandler Bean å¯¹è±¡ï¼Œæ˜¯åœ¨ <code>org.springframework.boot.autoconfigure.web.reactive.HttpHandlerAutoConfiguration</code> é…ç½®ç±»ä¸Šï¼Œè¢«åˆå§‹åŒ–å‡ºæ¥ã€‚</li>
</ul>
</li>
<li><p><code>&lt;2&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>ServerManager#start(ServerManager manager, Supplier&lt;HttpHandler&gt; handlerSupplier)</code> <strong>é™æ€</strong>æ–¹æ³•ï¼Œå¯åŠ¨ WebServer ã€‚</p>
</li>
<li><code>&lt;3&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>ServerManager#getWebServer(serverManager)</code> <strong>é™æ€</strong>æ–¹æ³•ï¼Œè·å¾— WebServer å¯¹è±¡ã€‚</li>
</ul>
<h2 id="5-6-onClose"><a href="#5-6-onClose" class="headerlink" title="5.6 onClose"></a>5.6 onClose</h2><p>è¦†å†™ <code>#onClose()</code> æ–¹æ³•ï¼Œåœ¨ Spring å®¹å™¨è¢«å…³é—­æ—¶ï¼Œå…³é—­ WebServer ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onClose</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="comment">// è°ƒç”¨çˆ¶ç±»æ–¹æ³•</span></span><br><span class="line">	<span class="keyword">super</span>.onClose();</span><br><span class="line">	<span class="comment">// å…³é—­ WebServer</span></span><br><span class="line">	stopAndReleaseReactiveWebServer();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="6-AnnotationConfigReactiveWebServerApplicationContext"><a href="#6-AnnotationConfigReactiveWebServerApplicationContext" class="headerlink" title="6. AnnotationConfigReactiveWebServerApplicationContext"></a>6. AnnotationConfigReactiveWebServerApplicationContext</h1><p><code>org.springframework.boot.web.reactive.context.AnnotationConfigReactiveWebServerApplicationContext</code> ï¼Œç»§æ‰¿ ReactiveWebServerApplicationContext ç±»ï¼Œå®ç° AnnotationConfigRegistry æ¥å£ï¼Œä½œç”¨å’Œ AnnotationConfigServletWebServerApplicationContext ç›¸åŒï¼Œå°±ä¸é‡å¤èµ˜è¿°äº†ã€‚</p>
<p>å¦‚æœçœŸè¦çœ‹çš„èƒ–å‹ï¼Œå‚è€ƒ <a href="http://svip.iocoder.cn/Spring-Boot/ServletWebServerApplicationContext/">ã€Šç²¾å°½ Spring Boot æºç åˆ†æ â€”â€” ServletWebServerApplicationContextã€‹</a> çš„ <a href="#">ã€Œ3. AnnotationConfigServletWebServerApplicationContextã€</a> å³å¯ã€‚</p>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ°´æ›´ä¸€ç¯‡ï¼Œæ— å¯â€œç‹¡è¾©â€ã€‚å˜»å˜»ã€‚</p>




</div>