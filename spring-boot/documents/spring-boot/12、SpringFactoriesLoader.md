<div class="article-entry" itemprop="articleBody">

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ï¼Œæˆ‘ä»¬æ¥è¡¥å…… <a href="http://svip.iocoder.cn/Spring-Boot/SpringApplication">ã€Šç²¾å°½ Spring Boot æºç åˆ†æ â€”â€” SpringApplicationã€‹</a> æ–‡ç« ï¼Œå¹¶æœªè¯¦ç»†è§£æçš„ SpringFactoriesLoader ã€‚</p>
<ul>
<li><p><code>spring.factories</code> é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºæ˜¯ Spring è‡ªå·±çš„ä¸€å¥— SPI æœºåˆ¶çš„é…ç½®æ–‡ä»¶ï¼Œåœ¨é‡Œé¢å¯ä»¥é…ç½®ä¸åŒæ¥å£å¯¹åº”çš„å®ç°ç±»<strong>ä»¬</strong>ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line"># PropertySource Loaders</span><br><span class="line">org.springframework.boot.env.PropertySourceLoader=\</span><br><span class="line">org.springframework.boot.env.PropertiesPropertySourceLoader,\</span><br><span class="line">org.springframework.boot.env.YamlPropertySourceLoader</span><br><span class="line"></span><br><span class="line"># Run Listeners</span><br><span class="line">org.springframework.boot.SpringApplicationRunListener=\</span><br><span class="line">org.springframework.boot.context.event.EventPublishingRunListener</span><br><span class="line"></span><br><span class="line">// ... çœç•¥å…¶å®ƒ</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¹¶ä¸”ï¼ŒSpring å†…ç½®äº†å¤šä¸ª <code>spring.factories</code> é…ç½®æ–‡ä»¶ã€‚å¦å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ·»åŠ  <code>spring.factories</code> é…ç½®æ–‡ä»¶ã€‚</li>
</ul>
</li>
<li><p>SpringFactoriesLoader ç±»ï¼Œç”¨äºåŠ è½½ <code>spring.factories</code> é…ç½®æ–‡ä»¶ã€‚</p>
</li>
</ul>
<blockquote>
<p>è‰¿è‰¿ï¼šå¦‚æœå¯¹ Java SPI ä¸äº†è§£çš„èƒ–å‹ï¼Œæ¨èåé¢çœ‹çœ‹ <a href="http://www.iocoder.cn/Fight/xuma/spi/?vip" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJAVA æ‹¾é— â€”â€” å…³äº SPI æœºåˆ¶ã€‹</a> æ–‡ç« ã€‚</p>
</blockquote>
<h1 id="2-SpringFactoriesLoader"><a href="#2-SpringFactoriesLoader" class="headerlink" title="2. SpringFactoriesLoader"></a>2. SpringFactoriesLoader</h1><p><code>org.springframework.core.io.support.SpringFactoriesLoader</code> ï¼ŒåŠ è½½ <code>spring.factories</code> çš„å·¥å…·ç±»ã€‚å…¶ç±»ä¸Šï¼Œæ³¨é‡Šå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// SpringFactoriesLoader.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * General purpose factory loading mechanism for internal use within the framework.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;{<span class="doctag">@code</span> SpringFactoriesLoader} {<span class="doctag">@linkplain</span> #loadFactories loads} and instantiates</span></span><br><span class="line"><span class="comment"> * factories of a given type from {<span class="doctag">@value</span> #FACTORIES_RESOURCE_LOCATION} files which</span></span><br><span class="line"><span class="comment"> * may be present in multiple JAR files in the classpath. The {<span class="doctag">@code</span> spring.factories}</span></span><br><span class="line"><span class="comment"> * file must be in {<span class="doctag">@link</span> Properties} format, where the key is the fully qualified</span></span><br><span class="line"><span class="comment"> * name of the interface or abstract class, and the value is a comma-separated list of</span></span><br><span class="line"><span class="comment"> * implementation class names. For example:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;pre class="code"&gt;example.MyService=example.MyServiceImpl1,example.MyServiceImpl2&lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * where {<span class="doctag">@code</span> example.MyService} is the name of the interface, and {<span class="doctag">@code</span> MyServiceImpl1}</span></span><br><span class="line"><span class="comment"> * and {<span class="doctag">@code</span> MyServiceImpl2} are two implementations.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></tbody></table></figure>
<p>ä»åŒ…åæˆ‘ä»¬å°±å¯ä»¥çœ‹å‡ºï¼ŒSpringFactoriesLoader æ˜¯ Spring Framework å°±å·²ç»æä¾›çš„å·¥å…·ç±»ï¼ŒğŸ˜ˆ è€Œä¸æ˜¯ Spring Boot æ‰€ç‰¹æœ‰çš„ã€‚</p>
<h2 id="2-1-æ„é€ æ–¹æ³•"><a href="#2-1-æ„é€ æ–¹æ³•" class="headerlink" title="2.1 æ„é€ æ–¹æ³•"></a>2.1 æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// SpringFactoriesLoader.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The location to look for factories.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Can be present in multiple JAR files.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FACTORIES_RESOURCE_LOCATION = <span class="string">"META-INF/spring.factories"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(SpringFactoriesLoader.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç¼“å­˜</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * KEY1 ï¼šClassLoader</span></span><br><span class="line"><span class="comment"> * KEY2 ï¼šæ¥å£çš„ç±»å</span></span><br><span class="line"><span class="comment"> * VALUE ï¼šå®ç°çš„ç±»åçš„æ•°ç»„ã€‚æ³¨æ„å“Ÿï¼Œæ˜¯ä¸ª MultiValueMap ç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;ClassLoader, MultiValueMap&lt;String, String&gt;&gt; cache = <span class="keyword">new</span> ConcurrentReferenceHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">SpringFactoriesLoader</span><span class="params">()</span> </span>{</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>FACTORIES_RESOURCE_LOCATION</code> é™æ€å±æ€§ï¼Œå®šä¹‰äº†è¯»å–çš„æ˜¯ <code>"META-INF/spring.factories"</code> é…ç½®æ–‡ä»¶ã€‚å¹¶ä¸”ï¼Œæ¯ä¸ª JAR æ–‡ä»¶é‡Œï¼Œéƒ½å¯ä»¥æœ‰ä¸€ä¸ªè¿™ä¸ªé…ç½®æ–‡ä»¶ã€‚</li>
<li><code>cache</code> é™æ€å±æ€§ï¼Œè¯»å– <code>"META-INF/spring.factories"</code> é…ç½®æ–‡ä»¶çš„ç¼“å­˜ã€‚</li>
</ul>
<h2 id="2-2-loadFactoryNames"><a href="#2-2-loadFactoryNames" class="headerlink" title="2.2 loadFactoryNames"></a>2.2 loadFactoryNames</h2><p><code>#loadFactoryNames(Class&lt;?&gt; factoryClass, @Nullable ClassLoader classLoader)</code> é™æ€æ–¹æ³•ï¼Œè·å¾—æ¥å£å¯¹åº”çš„å®ç°ç±»åä»¬ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// SpringFactoriesLoader.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Load the fully qualified class names of factory implementations of the</span></span><br><span class="line"><span class="comment"> * given type from {<span class="doctag">@value</span> #FACTORIES_RESOURCE_LOCATION}, using the given</span></span><br><span class="line"><span class="comment"> * class loader.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> factoryClass the interface or abstract class representing the factory</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classLoader the ClassLoader to use for loading resources; can be</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@code</span> null} to use the default</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalArgumentException if an error occurs while loading factory names</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #loadFactories</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">loadFactoryNames</span><span class="params">(Class&lt;?&gt; factoryClass, @Nullable ClassLoader classLoader)</span> </span>{</span><br><span class="line">    <span class="comment">// è·å¾—æ¥å£çš„ç±»å</span></span><br><span class="line">    String factoryClassName = factoryClass.getName();</span><br><span class="line">    <span class="comment">// åŠ è½½ FACTORIES_RESOURCE_LOCATION é…ç½®æ–‡ä»¶ï¼Œè·å¾—æ¥å£å¯¹åº”çš„å®ç°ç±»åä»¬</span></span><br><span class="line">    <span class="keyword">return</span> loadSpringFactories(classLoader).getOrDefault(factoryClassName, Collections.emptyList());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, List&lt;String&gt;&gt; loadSpringFactories(<span class="meta">@Nullable</span> ClassLoader classLoader) {</span><br><span class="line">    <span class="comment">// å¦‚æœç¼“å­˜ä¸­å·²ç»å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">    MultiValueMap&lt;String, String&gt; result = cache.get(classLoader);</span><br><span class="line">    <span class="keyword">if</span> (result != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// è·å¾— FACTORIES_RESOURCE_LOCATION å¯¹åº”çš„ URL ä»¬</span></span><br><span class="line">        Enumeration&lt;URL&gt; urls = (classLoader != <span class="keyword">null</span> ? classLoader.getResources(FACTORIES_RESOURCE_LOCATION) : ClassLoader.getSystemResources(FACTORIES_RESOURCE_LOCATION));</span><br><span class="line">        <span class="comment">// åˆ›å»º LinkedMultiValueMap å¯¹è±¡</span></span><br><span class="line">        result = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">        <span class="comment">// éå† URL æ•°ç»„</span></span><br><span class="line">        <span class="keyword">while</span> (urls.hasMoreElements()) {</span><br><span class="line">            <span class="comment">// è·å¾— URL</span></span><br><span class="line">            URL url = urls.nextElement();</span><br><span class="line">            <span class="comment">// åˆ›å»º UrlResource å¯¹è±¡</span></span><br><span class="line">            UrlResource resource = <span class="keyword">new</span> UrlResource(url);</span><br><span class="line">            <span class="comment">// åŠ è½½ "META-INF/spring.factories" é…ç½®æ–‡ä»¶ï¼Œæˆä¸º Properties å¯¹è±¡</span></span><br><span class="line">            Properties properties = PropertiesLoaderUtils.loadProperties(resource);</span><br><span class="line">            <span class="comment">// éå† Properties å¯¹è±¡</span></span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;?, ?&gt; entry : properties.entrySet()) {</span><br><span class="line">                <span class="comment">// ä½¿ç”¨é€—å·åˆ†éš”</span></span><br><span class="line">                List&lt;String&gt; factoryClassNames = Arrays.asList(StringUtils.commaDelimitedListToStringArray((String) entry.getValue()));</span><br><span class="line">                <span class="comment">// æ·»åŠ åˆ° result ä¸­</span></span><br><span class="line">                result.addAll((String) entry.getKey(), factoryClassNames);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// æ·»åŠ åˆ° cache ä¸­</span></span><br><span class="line">        cache.put(classLoader, result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    } <span class="keyword">catch</span> (IOException ex) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unable to load factories from location ["</span> + FACTORIES_RESOURCE_LOCATION + <span class="string">"]"</span>, ex);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åŠ è½½ <code>FACTORIES_RESOURCE_LOCATION</code> é…ç½®æ–‡ä»¶ï¼Œè·å¾—æ¥å£å¯¹åº”çš„å®ç°ç±»åä»¬ã€‚</li>
</ul>
<h2 id="2-3-loadFactories"><a href="#2-3-loadFactories" class="headerlink" title="2.3 loadFactories"></a>2.3 loadFactories</h2><p><code>#loadFactories(Class&lt;T&gt; factoryClass, @Nullable ClassLoader classLoader)</code> <strong>é™æ€</strong>æ–¹æ³•ï¼Œè·å¾—æ¥å£å¯¹åº”çš„å®ç°ç±»åä»¬ï¼Œç„¶ååˆ›å»ºå¯¹åº”çš„å¯¹è±¡ä»¬ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// SpringFactoriesLoader.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Load and instantiate the factory implementations of the given type from</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@value</span> #FACTORIES_RESOURCE_LOCATION}, using the given class loader.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;The returned factories are sorted through {<span class="doctag">@link</span> AnnotationAwareOrderComparator}.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;If a custom instantiation strategy is required, use {<span class="doctag">@link</span> #loadFactoryNames}</span></span><br><span class="line"><span class="comment"> * to obtain all registered factory names.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> factoryClass the interface or abstract class representing the factory</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classLoader the ClassLoader to use for loading (can be {<span class="doctag">@code</span> null} to use the default)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalArgumentException if any factory implementation class cannot</span></span><br><span class="line"><span class="comment"> * be loaded or if an error occurs while instantiating any factory</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #loadFactoryNames</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">loadFactories</span><span class="params">(Class&lt;T&gt; factoryClass, @Nullable ClassLoader classLoader)</span> </span>{</span><br><span class="line">    Assert.notNull(factoryClass, <span class="string">"'factoryClass' must not be null"</span>);</span><br><span class="line">    <span class="comment">// è·å¾— ClassLoader</span></span><br><span class="line">    ClassLoader classLoaderToUse = classLoader;</span><br><span class="line">    <span class="keyword">if</span> (classLoaderToUse == <span class="keyword">null</span>) {</span><br><span class="line">        classLoaderToUse = SpringFactoriesLoader.class.getClassLoader();</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// è·å¾—æ¥å£å¯¹åº”çš„å®ç°ç±»åä»¬</span></span><br><span class="line">    List&lt;String&gt; factoryNames = loadFactoryNames(factoryClass, classLoaderToUse);</span><br><span class="line">    <span class="keyword">if</span> (logger.isTraceEnabled()) {</span><br><span class="line">        logger.trace(<span class="string">"Loaded ["</span> + factoryClass.getName() + <span class="string">"] names: "</span> + factoryNames);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// éå† factoryNames æ•°ç»„ï¼Œåˆ›å»ºå®ç°ç±»çš„å¯¹è±¡</span></span><br><span class="line">    List&lt;T&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(factoryNames.size());</span><br><span class="line">    <span class="keyword">for</span> (String factoryName : factoryNames) {</span><br><span class="line">        result.add(instantiateFactory(factoryName, factoryClass, classLoaderToUse));</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// æ’åº</span></span><br><span class="line">    AnnotationAwareOrderComparator.sort(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">instantiateFactory</span><span class="params">(String instanceClassName, Class&lt;T&gt; factoryClass, ClassLoader classLoader)</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// è·å¾— Class ç±»</span></span><br><span class="line">        Class&lt;?&gt; instanceClass = ClassUtils.forName(instanceClassName, classLoader);</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦å®ç°äº†æŒ‡å®šæ¥å£</span></span><br><span class="line">        <span class="keyword">if</span> (!factoryClass.isAssignableFrom(instanceClass)) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Class ["</span> + instanceClassName + <span class="string">"] is not assignable to ["</span> + factoryClass.getName() + <span class="string">"]"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// åˆ›å»ºå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> (T) ReflectionUtils.accessibleConstructor(instanceClass).newInstance();</span><br><span class="line">    } <span class="keyword">catch</span> (Throwable ex) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unable to instantiate factory class: "</span> + factoryClass.getName(), ex);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ°´æ–‡ä¸€ç¯‡ï¼Œå“‡å’”å’”~</p>




</div>