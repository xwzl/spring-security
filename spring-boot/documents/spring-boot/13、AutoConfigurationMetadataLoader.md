<div class="article-entry" itemprop="articleBody">

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ï¼Œæˆ‘ä»¬æ¥è¡¥å…… <a href="http://svip.iocoder.cn/Spring-Boot/AutoConfiguration">ã€Šç²¾å°½ Spring Boot æºç åˆ†æ â€”â€” è‡ªåŠ¨é…ç½®ã€‹</a> æ–‡ç« ï¼Œå¹¶æœªè¯¦ç»†è§£æçš„ AutoConfigurationMetadataLoader ã€‚åœ¨ SpringApplication ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>AutoConfigurationImportSelector.AutoConfigurationGroup#loadMetadata(ClassLoader classLoader, String path)</code> æ–¹æ³•ä¸­ï¼ŒåŠ è½½è‡ªåŠ¨é…ç½®ç±»ï¼ˆAutoConfigurationï¼‰çš„å…ƒæ•°æ®ï¼Œæ˜¯å¦‚ä¸‹ä¸€æ®µä»£ç ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationImportSelector.AutoConfigurationGroup.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> è·å¾— AutoConfigurationMetadata å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> AutoConfigurationMetadata <span class="title">getAutoConfigurationMetadata</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡ŒåŠ è½½</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.autoConfigurationMetadata == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">this</span>.autoConfigurationMetadata = AutoConfigurationMetadataLoader.loadMetadata(<span class="keyword">this</span>.beanClassLoader);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.autoConfigurationMetadata;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨å†…éƒ¨ï¼Œä¼šè°ƒç”¨ <code>AutoConfigurationMetadataLoader#loadMetadata(ClassLoader classLoader)</code> æ–¹æ³•ï¼ŒåŠ è½½ AutoConfigurationMetadata å¯¹è±¡ã€‚</li>
<li>è€Œæˆ‘ä»¬çŸ¥é“ï¼Œåç»­ä¼šåŸºäºè¿”å›çš„ AutoConfigurationMetadata å¯¹è±¡ï¼Œè¿›è¡Œ AutoConfiguration ç±»çš„<strong>è¿‡æ»¤</strong>ï¼Œä»è€Œé¿å…ä¸ç¬¦åˆæ¡ä»¶çš„ AutoConfiguration ç±»çš„å­—èŠ‚ç ï¼ŒåŠ è½½åˆ° JVM ä¸­ã€‚é‚£ä¹ˆæ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿæˆ‘ä»¬æ¥ç€æ¥çœ‹ <a href="#">ã€Œ2. AutoConfigurationMetadataLoaderã€</a> ã€‚</li>
</ul>
<h1 id="2-AutoConfigurationMetadataLoader"><a href="#2-AutoConfigurationMetadataLoader" class="headerlink" title="2. AutoConfigurationMetadataLoader"></a>2. AutoConfigurationMetadataLoader</h1><p><code>org.springframework.boot.autoconfigure.AutoConfigurationMetadataLoader</code> ï¼ŒAutoConfigurationMetadata åŠ è½½å™¨ã€‚å…¶ç±»ä¸Šçš„æ³¨é‡Šå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Internal utility used to load {<span class="doctag">@link</span> AutoConfigurationMetadata}.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-1-loadMetadata"><a href="#2-1-loadMetadata" class="headerlink" title="2.1 loadMetadata"></a>2.1 loadMetadata</h2><p><code>#loadMetadata(ClassLoader classLoader)</code> <strong>é™æ€</strong>æ–¹æ³•ï¼ŒåŠ è½½ AutoConfigurationMetadata ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationMetadataLoader.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATH = <span class="string">"META-INF/"</span> + <span class="string">"spring-autoconfigure-metadata.properties"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AutoConfigurationMetadata <span class="title">loadMetadata</span><span class="params">(ClassLoader classLoader)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> loadMetadata(classLoader, PATH);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> AutoConfigurationMetadata <span class="title">loadMetadata</span><span class="params">(ClassLoader classLoader, String path)</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// &lt;1&gt; è·å¾— PATH å¯¹åº”çš„ URL ä»¬</span></span><br><span class="line">        Enumeration&lt;URL&gt; urls = (classLoader != <span class="keyword">null</span>) ? classLoader.getResources(path) : ClassLoader.getSystemResources(path);</span><br><span class="line">        <span class="comment">// &lt;2&gt; éå† URL æ•°ç»„ï¼Œè¯»å–åˆ° properties ä¸­</span></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        <span class="keyword">while</span> (urls.hasMoreElements()) {</span><br><span class="line">            properties.putAll(PropertiesLoaderUtils.loadProperties(<span class="keyword">new</span> UrlResource(urls.nextElement())));</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// &lt;3&gt; å°† properties è½¬æ¢æˆ PropertiesAutoConfigurationMetadata å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> loadMetadata(properties);</span><br><span class="line">    } <span class="keyword">catch</span> (IOException ex) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unable to load @ConditionalOnClass location ["</span> + path + <span class="string">"]"</span>, ex);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œè·å¾— <code>PATH</code> å¯¹åº”çš„ URL ä»¬ï¼Œè€Œ <code>PATH</code> å°±æ˜¯ <code>"META-INF/spring-autoconfigure-metadata.properties"</code> æ–‡ä»¶ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥é¿å…å» AutoConfiguration ç±»ä¸Šï¼Œè¯»å–å…¶ Condition æ¡ä»¶äº†ï¼Œä»è€Œé¿å…å°†ä¸ç¬¦åˆæ¡ä»¶çš„ AutoConfiguration ç±»çš„å­—èŠ‚ç ï¼ŒåŠ è½½åˆ° JVM ä¸­ã€‚é‚£ä¹ˆï¼Œæ­¤æ—¶å°±ä¼šæœ‰ä¸€ä¸ªç–‘é—®ï¼Œ<code>"META-INF/spring-autoconfigure-metadata.properties"</code> æ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿç­”æ¡ˆæˆ‘ä»¬åœ¨ <a href="#">ã€Œ3. AutoConfigureAnnotationProcessorã€</a> ä¸­è¯´ã€‚</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œéå† URL æ•°ç»„ï¼Œè¯»å–åˆ° <code>properties</code> ä¸­ã€‚</li>
<li><p><code>&lt;3&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#loadMetadata(Properties properties)</code> æ–¹æ³•ï¼Œå°† <code>properties</code> è½¬æ¢æˆ PropertiesAutoConfigurationMetadata å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationMetadataLoader.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> AutoConfigurationMetadata <span class="title">loadMetadata</span><span class="params">(Properties properties)</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> PropertiesAutoConfigurationMetadata(properties);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å…³äº PropertiesAutoConfigurationMetadata ç±»ï¼Œåœ¨ <a href="#">ã€Œ2.2 ã€</a> ä¸­çœ‹ã€‚ </li>
</ul>
</li>
</ul>
<h2 id="2-2-PropertiesAutoConfigurationMetadata"><a href="#2-2-PropertiesAutoConfigurationMetadata" class="headerlink" title="2.2 PropertiesAutoConfigurationMetadata"></a>2.2 PropertiesAutoConfigurationMetadata</h2><p>PropertiesAutoConfigurationMetadata ï¼Œæ˜¯ AutoConfigurationMetadataLoader çš„å†…éƒ¨é™æ€ç±»ï¼Œå®ç° AutoConfigurationMetadata æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationMetadataLoader#PropertiesAutoConfigurationMetadata.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> AutoConfigurationMetadata} implementation backed by a properties file.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertiesAutoConfigurationMetadata</span> <span class="keyword">implements</span> <span class="title">AutoConfigurationMetadata</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Properties å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Properties properties;</span><br><span class="line"></span><br><span class="line">    PropertiesAutoConfigurationMetadata(Properties properties) {</span><br><span class="line">        <span class="keyword">this</span>.properties = properties;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">wasProcessed</span><span class="params">(String className)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.properties.containsKey(className);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getInteger</span><span class="params">(String className, String key)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> getInteger(className, key, <span class="keyword">null</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getInteger</span><span class="params">(String className, String key, Integer defaultValue)</span> </span>{</span><br><span class="line">        String value = get(className, key);</span><br><span class="line">        <span class="keyword">return</span> (value != <span class="keyword">null</span>) ? Integer.valueOf(value) : defaultValue;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSet</span><span class="params">(String className, String key)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> getSet(className, key, <span class="keyword">null</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSet</span><span class="params">(String className, String key, Set&lt;String&gt; defaultValue)</span> </span>{</span><br><span class="line">        String value = get(className, key);</span><br><span class="line">        <span class="keyword">return</span> (value != <span class="keyword">null</span>) ? StringUtils.commaDelimitedListToSet(value) : defaultValue;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(String className, String key)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> get(className, key, <span class="keyword">null</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(String className, String key, String defaultValue)</span> </span>{</span><br><span class="line">        String value = <span class="keyword">this</span>.properties.getProperty(className + <span class="string">"."</span> + key);</span><br><span class="line">        <span class="keyword">return</span> (value != <span class="keyword">null</span>) ? value : defaultValue;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="3-AutoConfigureAnnotationProcessor"><a href="#3-AutoConfigureAnnotationProcessor" class="headerlink" title="3. AutoConfigureAnnotationProcessor"></a>3. AutoConfigureAnnotationProcessor</h1><p>åœ¨ Spring Boot çš„æºç ä¸­ï¼Œæˆ‘ä»¬å¦‚æœå»æ£€ç´¢ <code>"spring-autoconfigure-metadata.properties"</code> æ–‡ä»¶ï¼Œç„¶è€Œå¹¶æ‰¾ä¸åˆ°ã€‚æ˜¯ä¸æ˜¯æ„Ÿè§‰å¾ˆå¥‡æ€ªã€‚äºæ˜¯ä¹ï¼Œè‰¿è‰¿åœ¨æœç´¢äº†ä¸€äº›ç½‘ç»œçš„ä¸Šçš„èµ„æ–™ï¼ŒåŸæ¥æ˜¯éœ€è¦å¼•å…¥ <code>spring-boot-autoconfigure-processor</code> ä¾èµ–ã€‚è¿™æ ·ï¼Œå®ƒçš„ AutoConfigureAnnotationProcessor ç±»ï¼Œå°±ä¼šè‡ªåŠ¨æ ¹æ® AutoConfiguration ç±»çš„æ¡ä»¶ï¼Œç”Ÿæˆ <code>"META-INF/spring-autoconfigure-metadata.properties"</code> æ–‡ä»¶ã€‚</p>
<p>é‚£ä¹ˆï¼Œæ­¤æ—¶åˆä¼šæœ‰ä¸€ä¸ªç–‘æƒ‘ï¼Œé‚£æ˜¯ä»€ä¹ˆæ—¶å€™ç”Ÿæˆå‘¢ï¼ŸAutoConfigureAnnotationProcessor ç»§æ‰¿è‡ª <code>javax.annotation.processing.AbstractProcessor</code> ç±»ï¼Œå®ƒå¯ä»¥åœ¨<strong>ç¼–è¯‘æ—¶</strong>ï¼Œæ‰«æå’Œå¤„ç†æ³¨è§£ï¼ˆAnnotationï¼‰ï¼Œä»è€Œç”Ÿæˆ <code>"META-INF/spring-autoconfigure-metadata.properties"</code> æ–‡ä»¶ã€‚ğŸ˜ˆ å¾ˆæœ‰æ„æ€ã€‚</p>
<blockquote>
<p>FROM <a href="https://www.race604.com/annotation-processing/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJava æ³¨è§£å¤„ç†å™¨ã€‹</a></p>
<p>æ³¨è§£å¤„ç†å™¨ï¼ˆAnnotation Processorï¼‰æ˜¯<strong>javac</strong>çš„ä¸€ä¸ªå·¥å…·ï¼Œå®ƒç”¨æ¥åœ¨ç¼–è¯‘æ—¶æ‰«æå’Œå¤„ç†æ³¨è§£ï¼ˆAnnotationï¼‰ã€‚ä½ å¯ä»¥å¯¹è‡ªå®šä¹‰æ³¨è§£ï¼Œå¹¶æ³¨å†Œç›¸åº”çš„æ³¨è§£å¤„ç†å™¨ã€‚åˆ°è¿™é‡Œï¼Œæˆ‘å‡è®¾ä½ å·²ç»çŸ¥é“ä»€ä¹ˆæ˜¯æ³¨è§£ï¼Œå¹¶ä¸”çŸ¥é“æ€ä¹ˆç”³æ˜çš„ä¸€ä¸ªæ³¨è§£ã€‚å¦‚æœä½ ä¸ç†Ÿæ‚‰æ³¨è§£ï¼Œä½ å¯ä»¥åœ¨è¿™<a href="http://docs.oracle.com/javase/tutorial/java/annotations/index.html" rel="external nofollow noopener noreferrer" target="_blank">å®˜æ–¹æ–‡æ¡£</a>ä¸­å¾—åˆ°æ›´å¤šä¿¡æ¯ã€‚æ³¨è§£å¤„ç†å™¨åœ¨Java 5å¼€å§‹å°±æœ‰äº†ï¼Œä½†æ˜¯ä»Java 6ï¼ˆ2006å¹´12æœˆå‘å¸ƒï¼‰å¼€å§‹æ‰æœ‰å¯ç”¨çš„APIã€‚è¿‡äº†ä¸€äº›æ—¶é—´ï¼ŒJavaä¸–ç•Œæ‰æ„è¯†åˆ°æ³¨è§£å¤„ç†å™¨çš„å¼ºå¤§ä½œç”¨ï¼Œæ‰€ä»¥å®ƒåˆ°æœ€è¿‘å‡ å¹´æ‰æµè¡Œèµ·æ¥ã€‚</p>
</blockquote>
<p>é‚£ä¹ˆï¼Œæˆ‘ä»¬å¼€å§‹æ’¸æ’¸ AutoConfigureAnnotationProcessor çš„æºç å§ã€‚</p>
<p><code>org.springframework.boot.autoconfigureprocessor.AutoConfigureAnnotationProcessor</code> ï¼Œç»§æ‰¿ AbstractProcessor æŠ½è±¡ç±»ï¼Œæ ¹æ® AutoConfiguration ç±»çš„æ¡ä»¶ï¼Œç”Ÿæˆ <code>"META-INF/spring-autoconfigure-metadata.properties"</code> æ–‡ä»¶ã€‚å…¶ç±»ä¸Šæ³¨é‡Šå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigureAnnotationProcessor.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Annotation processor to store certain annotations from auto-configuration classes in a</span></span><br><span class="line"><span class="comment"> * property file.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-1-æ„é€ æ–¹æ³•"><a href="#3-1-æ„é€ æ–¹æ³•" class="headerlink" title="3.1 æ„é€ æ–¹æ³•"></a>3.1 æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigureAnnotationProcessor.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ³¨è§£åå’Œå…¨ç±»åçš„æ˜ å°„</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * KEYï¼šæ³¨è§£å</span></span><br><span class="line"><span class="comment"> * VALUEï¼šå…¨ç±»å</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; annotations;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ³¨è§£åå’Œ ValueExtractor çš„æ˜ å°„</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * KEYï¼šæ³¨è§£å</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ValueExtractor&gt; valueExtractors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰«æå’Œå¤„ç†æ³¨è§£ï¼ˆAnnotationï¼‰ï¼Œç”Ÿæˆçš„ Properties å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AutoConfigureAnnotationProcessor</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; åˆå§‹åŒ– annotations å±æ€§</span></span><br><span class="line">    Map&lt;String, String&gt; annotations = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">    addAnnotations(annotations);</span><br><span class="line">    <span class="keyword">this</span>.annotations = Collections.unmodifiableMap(annotations);</span><br><span class="line">    <span class="comment">// &lt;2&gt; åˆå§‹åŒ– valueExtractors å±æ€§</span></span><br><span class="line">    Map&lt;String, ValueExtractor&gt; valueExtractors = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">    addValueExtractors(valueExtractors);</span><br><span class="line">    <span class="keyword">this</span>.valueExtractors = Collections.unmodifiableMap(valueExtractors);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>annotations</code> å±æ€§ï¼Œæ³¨è§£åå’Œå…¨ç±»åçš„æ˜ å°„ã€‚åœ¨ <code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#addAnnotations(Map&lt;String, String&gt; annotations)</code> æ–¹æ³•ï¼Œè¿›è¡Œåˆå§‹åŒ–ã€‚ä»£ç å¦‚ä¸‹ï¼š  <figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigureAnnotationProcessor.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addAnnotations</span><span class="params">(Map&lt;String, String&gt; annotations)</span> </span>{</span><br><span class="line">	<span class="comment">// æ¡ä»¶</span></span><br><span class="line">	annotations.put(<span class="string">"Configuration"</span>, <span class="string">"org.springframework.context.annotation.Configuration"</span>);</span><br><span class="line">	annotations.put(<span class="string">"ConditionalOnClass"</span>, <span class="string">"org.springframework.boot.autoconfigure.condition.ConditionalOnClass"</span>);</span><br><span class="line">	annotations.put(<span class="string">"ConditionalOnBean"</span>, <span class="string">"org.springframework.boot.autoconfigure.condition.ConditionalOnBean"</span>);</span><br><span class="line">	annotations.put(<span class="string">"ConditionalOnSingleCandidate"</span>, <span class="string">"org.springframework.boot.autoconfigure.condition.ConditionalOnSingleCandidate"</span>);</span><br><span class="line">	annotations.put(<span class="string">"ConditionalOnWebApplication"</span>, <span class="string">"org.springframework.boot.autoconfigure.condition.ConditionalOnWebApplication"</span>);</span><br><span class="line">	<span class="comment">// æ’åº</span></span><br><span class="line">	annotations.put(<span class="string">"AutoConfigureBefore"</span>, <span class="string">"org.springframework.boot.autoconfigure.AutoConfigureBefore"</span>);</span><br><span class="line">	annotations.put(<span class="string">"AutoConfigureAfter"</span>, <span class="string">"org.springframework.boot.autoconfigure.AutoConfigureAfter"</span>);</span><br><span class="line">	annotations.put(<span class="string">"AutoConfigureOrder"</span>, <span class="string">"org.springframework.boot.autoconfigure.AutoConfigureOrder"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li><code>valueExtractors</code> å±æ€§ï¼Œæ³¨è§£åå’Œ ValueExtractor çš„æ˜ å°„ã€‚åœ¨ <code>&lt;2&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#addValueExtractors(Map&lt;String, ValueExtractor&gt; attributes)</code> æ–¹æ³•ï¼Œè¿›è¡Œåˆå§‹åŒ–ã€‚ä»£ç å¦‚ä¸‹ï¼š  <figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigureAnnotationProcessor.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addValueExtractors</span><span class="params">(Map&lt;String, ValueExtractor&gt; attributes)</span> </span>{</span><br><span class="line">    attributes.put(<span class="string">"Configuration"</span>, ValueExtractor.allFrom(<span class="string">"value"</span>));</span><br><span class="line">    attributes.put(<span class="string">"ConditionalOnClass"</span>, <span class="keyword">new</span> OnClassConditionValueExtractor());</span><br><span class="line">    attributes.put(<span class="string">"ConditionalOnBean"</span>, <span class="keyword">new</span> OnBeanConditionValueExtractor());</span><br><span class="line">    attributes.put(<span class="string">"ConditionalOnSingleCandidate"</span>, <span class="keyword">new</span> OnBeanConditionValueExtractor());</span><br><span class="line">    attributes.put(<span class="string">"ConditionalOnWebApplication"</span>, ValueExtractor.allFrom(<span class="string">"type"</span>));</span><br><span class="line">    attributes.put(<span class="string">"AutoConfigureBefore"</span>, ValueExtractor.allFrom(<span class="string">"value"</span>, <span class="string">"name"</span>));</span><br><span class="line">    attributes.put(<span class="string">"AutoConfigureAfter"</span>, ValueExtractor.allFrom(<span class="string">"value"</span>, <span class="string">"name"</span>));</span><br><span class="line">    attributes.put(<span class="string">"AutoConfigureOrder"</span>, ValueExtractor.allFrom(<span class="string">"value"</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li><code>properties</code> å±æ€§ï¼Œæ‰«æå’Œå¤„ç†æ³¨è§£ï¼ˆAnnotationï¼‰ï¼Œç”Ÿæˆçš„ Properties å¯¹è±¡ã€‚</li>
</ul>
<h2 id="3-2-ValueExtractor"><a href="#3-2-ValueExtractor" class="headerlink" title="3.2 ValueExtractor"></a>3.2 ValueExtractor</h2><p>ValueExtractor ï¼Œæ˜¯ AutoConfigureAnnotationProcessor çš„å†…éƒ¨æ¥å£ï¼Œå€¼æå–å™¨æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigureAnnotationProcessor#ValueExtractor.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">interface</span> <span class="title">ValueExtractor</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»æ³¨è§£ä¸­ï¼Œè·å¾—å¯¹åº”çš„å€¼çš„æ•°ç»„</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> annotation æ³¨è§£</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å€¼çš„æ•°ç»„</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Object&gt; <span class="title">getValues</span><span class="params">(AnnotationMirror annotation)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ›å»º NamedValuesExtractor å¯¹è±¡</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> names ä»æ³¨è§£çš„æŒ‡å®š names ä¸­ï¼Œæå–å€¼ä»¬</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> NamedValuesExtractor å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> ValueExtractor <span class="title">allFrom</span><span class="params">(String... names)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> NamedValuesExtractor(names);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="3-2-1-AbstractValueExtractor"><a href="#3-2-1-AbstractValueExtractor" class="headerlink" title="3.2.1 AbstractValueExtractor"></a>3.2.1 AbstractValueExtractor</h3><p>AbstractValueExtractor ï¼Œæ˜¯ AutoConfigureAnnotationProcessor çš„å†…éƒ¨ç±»ï¼Œå®ç° ValueExtractor æ¥å£ï¼ŒValueExtractor æŠ½è±¡å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigureAnnotationProcessor#AbstractValueExtractor.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractValueExtractor</span> <span class="keyword">implements</span> <span class="title">ValueExtractor</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Stream&lt;Object&gt; <span class="title">extractValues</span><span class="params">(AnnotationValue annotationValue)</span> </span>{</span><br><span class="line">        <span class="comment">// æ³¨è§£å€¼ä¸ºç©ºï¼Œè¿”å›ç©º</span></span><br><span class="line">        <span class="keyword">if</span> (annotationValue == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">return</span> Stream.empty();</span><br><span class="line">        }</span><br><span class="line">        Object value = annotationValue.getValue();</span><br><span class="line">        <span class="comment">// æ³¨è§£å€¼ä¸ºæ•°ç»„ï¼Œåˆ™éå†æ•°ç»„ï¼Œé€ä¸ªæå–å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (value <span class="keyword">instanceof</span> List) {</span><br><span class="line">            <span class="keyword">return</span> ((List&lt;AnnotationValue&gt;) value).stream()</span><br><span class="line">                    .map((annotation) -&gt; extractValue(annotation.getValue()));</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// æ³¨è§£å€¼éæ•°ç»„ï¼Œç›´æ¥æå–å€¼</span></span><br><span class="line">        <span class="keyword">return</span> Stream.of(extractValue(value));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">extractValue</span><span class="params">(Object value)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (value <span class="keyword">instanceof</span> DeclaredType) {</span><br><span class="line">            <span class="keyword">return</span> Elements.getQualifiedName(((DeclaredType) value).asElement());</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æä¾›äº†ä» AnnotationValue è¯»å–å€¼çš„å…¬ç”¨æ–¹æ³•ã€‚</li>
</ul>
<h3 id="3-2-2-NamedValuesExtractor"><a href="#3-2-2-NamedValuesExtractor" class="headerlink" title="3.2.2 NamedValuesExtractor"></a>3.2.2 NamedValuesExtractor</h3><p>NamedValuesExtractor ï¼Œæ˜¯ AutoConfigureAnnotationProcessor çš„å†…éƒ¨ç±»ï¼Œç»§æ‰¿ AbstractValueExtractor æŠ½è±¡ç±»ï¼Œè¯»å– <code>names</code> çš„ ValueExtractor å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigureAnnotationProcessor#NamedValuesExtractor.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">NamedValuesExtractor</span> <span class="keyword">extends</span> <span class="title">AbstractValueExtractor</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; names;</span><br><span class="line"></span><br><span class="line">    NamedValuesExtractor(String... names) {</span><br><span class="line">        <span class="keyword">this</span>.names = <span class="keyword">new</span> HashSet&lt;&gt;(Arrays.asList(names));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">getValues</span><span class="params">(AnnotationMirror annotation)</span> </span>{</span><br><span class="line">        List&lt;Object&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// éå† names æ•°ç»„ï¼Œè¯»å– name å¯¹åº”çš„å€¼ï¼Œæ·»åŠ åˆ° result ä¸­</span></span><br><span class="line">        annotation.getElementValues().forEach((key, value) -&gt; {</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.names.contains(key.getSimpleName().toString())) {</span><br><span class="line">                extractValues(value).forEach(result::add);</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="3-2-3-OnBeanConditionValueExtractor"><a href="#3-2-3-OnBeanConditionValueExtractor" class="headerlink" title="3.2.3 OnBeanConditionValueExtractor"></a>3.2.3 OnBeanConditionValueExtractor</h3><p>OnBeanConditionValueExtractor ï¼Œæ˜¯ AutoConfigureAnnotationProcessor çš„å†…éƒ¨ç±»ï¼Œç»§æ‰¿ AbstractValueExtractor æŠ½è±¡ç±»ï¼Œè¯»å– <code>@ConditionalOnBean</code> å’Œ <code>@ConditionalOnSingleCandidate</code> æ³¨è§£çš„ ValueExtractor å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigureAnnotationProcessor#OnBeanConditionValueExtractor.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OnBeanConditionValueExtractor</span> <span class="keyword">extends</span> <span class="title">AbstractValueExtractor</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">getValues</span><span class="params">(AnnotationMirror annotation)</span> </span>{</span><br><span class="line">        <span class="comment">// éå†æ³¨è§£çš„å…ƒç´ ä»¬ï¼Œè¯»å–åˆ° attributes ä¸­</span></span><br><span class="line">        Map&lt;String, AnnotationValue&gt; attributes = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">        annotation.getElementValues().forEach((key, value) -&gt; attributes.put(key.getSimpleName().toString(), value));</span><br><span class="line">        <span class="comment">// å¦‚æœ "name" å¯¹åº”çš„å€¼ä¸ºç©ºï¼Œè¿”å›ç©º</span></span><br><span class="line">        <span class="keyword">if</span> (attributes.containsKey(<span class="string">"name"</span>)) {</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// è¯»å– "value"ã€`"type"` å¯¹åº”çš„å€¼ï¼Œæ·»åŠ åˆ° result ä¸­</span></span><br><span class="line">        List&lt;Object&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        extractValues(attributes.get(<span class="string">"value"</span>)).forEach(result::add);</span><br><span class="line">        extractValues(attributes.get(<span class="string">"type"</span>)).forEach(result::add);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="3-2-4-OnClassConditionValueExtractor"><a href="#3-2-4-OnClassConditionValueExtractor" class="headerlink" title="3.2.4 OnClassConditionValueExtractor"></a>3.2.4 OnClassConditionValueExtractor</h3><p>OnClassConditionValueExtractor ï¼Œæ˜¯ AutoConfigureAnnotationProcessor çš„å†…éƒ¨ç±»ï¼Œç»§æ‰¿ NamedValuesExtractor ç±»ï¼Œè¯»å–  <code>@OnClassConditionValueExtractor</code> æ³¨è§£çš„ ValueExtractor å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigureAnnotationProcessor#OnClassConditionValueExtractor.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OnClassConditionValueExtractor</span> <span class="keyword">extends</span> <span class="title">NamedValuesExtractor</span> </span>{</span><br><span class="line"></span><br><span class="line">    OnClassConditionValueExtractor() {</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">"value"</span>, <span class="string">"name"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">getValues</span><span class="params">(AnnotationMirror annotation)</span> </span>{</span><br><span class="line">        <span class="comment">// è¯»å– "value", "name" çš„å€¼</span></span><br><span class="line">        List&lt;Object&gt; values = <span class="keyword">super</span>.getValues(annotation);</span><br><span class="line">        <span class="comment">// æ’åº</span></span><br><span class="line">        values.sort(<span class="keyword">this</span>::compare);</span><br><span class="line">        <span class="keyword">return</span> values;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Object o1, Object o2)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> Comparator.comparing(<span class="keyword">this</span>::isSpringClass)</span><br><span class="line">                .thenComparing(String.CASE_INSENSITIVE_ORDER)</span><br><span class="line">                .compare(o1.toString(), o2.toString());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isSpringClass</span><span class="params">(String type)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> type.startsWith(<span class="string">"org.springframework"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-3-process"><a href="#3-3-process" class="headerlink" title="3.3 process"></a>3.3 process</h2><p>å®ç° <code>#process(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</code> æ–¹æ³•ï¼Œè¿›è¡Œå¤„ç†ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigureAnnotationProcessor.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; éå† annotations é›†åˆï¼Œé€ä¸ªå¤„ç†</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : <span class="keyword">this</span>.annotations.entrySet()) {</span><br><span class="line">		process(roundEnv, entry.getKey(), entry.getValue());</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// &lt;2&gt; å¤„ç†å®Œæˆï¼Œå†™åˆ°æ–‡ä»¶ PROPERTIES_PATH ä¸­</span></span><br><span class="line">	<span class="keyword">if</span> (roundEnv.processingOver()) {</span><br><span class="line">		<span class="keyword">try</span> {</span><br><span class="line">			writeProperties();</span><br><span class="line">		} <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Failed to write metadata"</span>, ex);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p><code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#process(RoundEnvironment roundEnv, String propertyKey, String annotationName)</code> æ–¹æ³•ï¼Œéå† <code>annotations</code> é›†åˆï¼Œé€ä¸ªå¤„ç†ï¼Œæ·»åŠ åˆ° <code>properties</code> ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigureAnnotationProcessor.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(RoundEnvironment roundEnv, String propertyKey, String annotationName)</span> </span>{</span><br><span class="line">    TypeElement annotationType = <span class="keyword">this</span>.processingEnv.getElementUtils().getTypeElement(annotationName);</span><br><span class="line">    <span class="keyword">if</span> (annotationType != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">for</span> (Element element : roundEnv.getElementsAnnotatedWith(annotationType)) {</span><br><span class="line">            Element enclosingElement = element.getEnclosingElement();</span><br><span class="line">            <span class="keyword">if</span> (enclosingElement != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; enclosingElement.getKind() == ElementKind.PACKAGE) {</span><br><span class="line">                processElement(element, propertyKey, annotationName);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// propertyKey=æ³¨è§£å</span></span><br><span class="line"><span class="comment">// annotationName=å…¨ç±»å</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processElement</span><span class="params">(Element element, String propertyKey, String annotationName)</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// è·å¾—è‡ªåŠ¨é…ç½®ç±»çš„å…¨ç±»åã€‚ä¾‹å¦‚è¯´ï¼šorg.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration</span></span><br><span class="line">        String qualifiedName = Elements.getQualifiedName(element);</span><br><span class="line">        <span class="comment">// è·å¾— AnnotationMirror å¯¹è±¡</span></span><br><span class="line">        AnnotationMirror annotation = getAnnotation(element, annotationName);</span><br><span class="line">        <span class="keyword">if</span> (qualifiedName != <span class="keyword">null</span> &amp;&amp; annotation != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">// è·å¾—å€¼</span></span><br><span class="line">            List&lt;Object&gt; values = getValues(propertyKey, annotation);</span><br><span class="line">            <span class="comment">// æ·»åŠ åˆ° properties ä¸­</span></span><br><span class="line">            <span class="keyword">this</span>.properties.put(qualifiedName + <span class="string">"."</span> + propertyKey, toCommaDelimitedString(values));</span><br><span class="line">            <span class="comment">// æ·»åŠ åˆ° properties ä¸­</span></span><br><span class="line">            <span class="keyword">this</span>.properties.put(qualifiedName, <span class="string">""</span>);</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Error processing configuration meta-data on "</span> + element, ex);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å¾— AnnotationMirror å¯¹è±¡</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> AnnotationMirror <span class="title">getAnnotation</span><span class="params">(Element element, String type)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (element != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">for</span> (AnnotationMirror annotation : element.getAnnotationMirrors()) {</span><br><span class="line">            <span class="keyword">if</span> (type.equals(annotation.getAnnotationType().toString())) {</span><br><span class="line">                <span class="keyword">return</span> annotation;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å¾—å€¼</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;Object&gt; <span class="title">getValues</span><span class="params">(String propertyKey, AnnotationMirror annotation)</span> </span>{</span><br><span class="line">    ValueExtractor extractor = <span class="keyword">this</span>.valueExtractors.get(propertyKey);</span><br><span class="line">    <span class="keyword">if</span> (extractor == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> extractor.getValues(annotation);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‹¼æ¥å€¼</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">toCommaDelimitedString</span><span class="params">(List&lt;Object&gt; list)</span> </span>{</span><br><span class="line">    StringBuilder result = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">for</span> (Object item : list) {</span><br><span class="line">        result.append((result.length() != <span class="number">0</span>) ? <span class="string">","</span> : <span class="string">""</span>);</span><br><span class="line">        result.append(item);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> result.toString();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>èƒ–å‹ç®€å•ç…ä¸¤çœ¼å³å¯ï¼Œä¸æ˜¯å¾ˆé‡è¦å“ˆ~</li>
</ul>
</li>
<li><p><code>&lt;2&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#writeProperties()</code> æ–¹æ³•ï¼Œå¤„ç†å®Œæˆï¼Œå†™åˆ°æ–‡ä»¶ <code>PROPERTIES_PATH</code> ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigureAnnotationProcessor.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String PROPERTIES_PATH = <span class="string">"META-INF/"</span> + <span class="string">"spring-autoconfigure-metadata.properties"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeProperties</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.properties.isEmpty()) {</span><br><span class="line">        <span class="comment">// åˆ›å»º FileObject å¯¹è±¡</span></span><br><span class="line">        FileObject file = <span class="keyword">this</span>.processingEnv.getFiler().createResource(StandardLocation.CLASS_OUTPUT, <span class="string">""</span>, PROPERTIES_PATH);</span><br><span class="line">        <span class="comment">// å†™å…¥ properties åˆ°æ–‡ä»¶</span></span><br><span class="line">        <span class="keyword">try</span> (OutputStream outputStream = file.openOutputStream()) {</span><br><span class="line">            <span class="keyword">this</span>.properties.store(outputStream, <span class="keyword">null</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è¿™ä¸ï¼Œå’Œ <a href="#">ã€Œ2. AutoConfigurationMetadataLoaderã€</a> å°±å¯¹ä¸Šåˆ—ã€‚</li>
</ul>
</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ğŸ˜ˆ ç®€å•å°æ–‡ä¸€ç¯‡~åœ¨ <code>spring-boot-autoconfigure-processor</code> çš„å¯»æ‰¾ä¸Šï¼ŒèŠ±äº†ä¸€äº›äº›æ—¶é—´ã€‚HOHO ~</p>




</div>