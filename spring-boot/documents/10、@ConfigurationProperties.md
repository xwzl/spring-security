<div class="article-entry" itemprop="articleBody">

<h1>1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡æˆ‘ä»¬æ¥åˆ†äº« <code>@ConfigurationProperties</code> æ³¨è§£ï¼Œå¦‚ä½•å°†é…ç½®æ–‡ä»¶è‡ªåŠ¨è®¾ç½®åˆ°è¢«æ³¨è§£çš„ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationProperties.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Annotation for externalized configuration. Add this to a class definition or a</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@code</span> <span class="doctag">@Bean</span>} method in a {<span class="doctag">@code</span> <span class="doctag">@Configuration</span>} class if you want to bind and validate</span></span><br><span class="line"><span class="comment"> * some external Properties (e.g. from a .properties file).</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Note that contrary to {<span class="doctag">@code</span> <span class="doctag">@Value</span>}, SpEL expressions are not evaluated since property</span></span><br><span class="line"><span class="comment"> * values are externalized.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Dave Syer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ConfigurationPropertiesBindingPostProcessor</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> EnableConfigurationProperties</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>({ElementType.TYPE, ElementType.METHOD})</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ConfigurationProperties {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name prefix of the properties that are valid to bind to this object. Synonym</span></span><br><span class="line"><span class="comment">     * for {<span class="doctag">@link</span> #prefix()}. A valid prefix is defined by one or more words separated</span></span><br><span class="line"><span class="comment">     * with dots (e.g. {<span class="doctag">@code</span> "acme.system.feature"}).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the name prefix of the properties to bind</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AliasFor</span>(<span class="string">"prefix"</span>)</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name prefix of the properties that are valid to bind to this object. Synonym</span></span><br><span class="line"><span class="comment">     * for {<span class="doctag">@link</span> #value()}. A valid prefix is defined by one or more words separated with</span></span><br><span class="line"><span class="comment">     * dots (e.g. {<span class="doctag">@code</span> "acme.system.feature"}).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the name prefix of the properties to bind</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AliasFor</span>(<span class="string">"value"</span>)</span><br><span class="line">    <span class="function">String <span class="title">prefix</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Flag to indicate that when binding to this object invalid fields should be ignored.</span></span><br><span class="line"><span class="comment">     * Invalid means invalid according to the binder that is used, and usually this means</span></span><br><span class="line"><span class="comment">     * fields of the wrong type (or that cannot be coerced into the correct type).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the flag value (default false)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">ignoreInvalidFields</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Flag to indicate that when binding to this object unknown fields should be ignored.</span></span><br><span class="line"><span class="comment">     * An unknown field could be a sign of a mistake in the Properties.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the flag value (default true)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">ignoreUnknownFields</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><code>@ConfigurationProperties</code> æ³¨è§£æœ‰ä¸¤ç§ä½¿ç”¨æ–¹æ³•ï¼Œå¯è§ <a href="https://www.jianshu.com/p/7f54da1cb2eb" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå…³ä¸ @EnableConfigurationProperties æ³¨è§£ã€‹</a> æ–‡ç« ã€‚æ€»ç»“æ¥è¯´ï¼š</p>
<ul>
<li>ç¬¬ä¸€ç§ï¼Œ<code>@Component</code> + <code>@ConfigurationProperties</code> ã€‚</li>
<li>ç¬¬äºŒç§ï¼Œ<code>@EnableConfigurationProperties</code> + <code>ConfigurationProperties</code> ã€‚</li>
</ul>
<p>å®é™…æƒ…å†µä¸‹ï¼Œæ›´å¤šçš„æ˜¯ä½¿ç”¨ç¬¬ä¸€ç§ã€‚å½“ç„¶ï¼Œç¬¬äºŒç§çš„ <code>@EnableConfigurationProperties</code> çš„æ•ˆæœï¼Œä¹Ÿæ˜¯å°†æŒ‡å®šçš„ç±»ï¼Œå®ç°å’Œ <code>@Component</code> è¢«æ³¨è§£çš„ç±»æ˜¯ä¸€æ ·çš„ï¼Œåˆ›å»ºæˆ Bean å¯¹è±¡ã€‚<br>
è¿™æ ·ï¼Œ<code>@ConfigurationProperties</code> å°±å¯ä»¥å°†é…ç½®æ–‡ä»¶è‡ªåŠ¨è®¾ç½®åˆ°è¯¥ Bean å¯¹è±¡å’§ã€‚</p>
<h1>2. @EnableConfigurationProperties</h1>
<p><code>org.springframework.boot.context.properties.@EnableConfigurationProperties</code> æ³¨è§£ï¼Œå¯ä»¥å°†æŒ‡å®šå¸¦æœ‰ <code>@ConfigurationProperties</code> çš„ç±»ï¼Œæ³¨å†Œæˆ BeanDefinition ï¼Œä»è€Œåˆ›å»ºæˆ Bean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// EnableConfigurationProperties.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Enable support for {<span class="doctag">@link</span> ConfigurationProperties} annotated beans.</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> ConfigurationProperties} beans can be registered in the standard way (for</span></span><br><span class="line"><span class="comment"> * example using {<span class="doctag">@link</span> Bean <span class="doctag">@Bean</span>} methods) or, for convenience, can be specified</span></span><br><span class="line"><span class="comment"> * directly on this annotation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Dave Syer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import</span>(EnableConfigurationPropertiesImportSelector.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableConfigurationProperties {</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŒ‡å®šçš„ç±»ä»¬</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">	 * Convenient way to quickly register {<span class="doctag">@link</span> ConfigurationProperties} annotated beans</span></span><br><span class="line"><span class="comment">	 * with Spring. Standard Spring Beans will also be scanned regardless of this value.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> {<span class="doctag">@link</span> ConfigurationProperties} annotated beans to register</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Class&lt;?&gt;[] value() <span class="keyword">default</span> {};</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>ä» <code>@Import</code> æ³¨è§£ä¸Šï¼Œå¯ä»¥çœ‹åˆ°ä½¿ç”¨ EnableConfigurationPropertiesImportSelector å¤„ç†ã€‚è¯¦ç»†çš„è§£æï¼Œè§ <a href="#">ã€Œ2.2 EnableConfigurationPropertiesImportSelectorã€</a> ã€‚</li>
</ul>
<h2>2.1 ConfigurationPropertiesAutoConfiguration</h2>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>@EnableConfigurationProperties</code> ä¼šé€šè¿‡ <code>org.springframework.boot.autoconfigure.context.ConfigurationPropertiesAutoConfiguration</code> ç±»ï¼Œè¿›è¡Œå¼€å¯ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationPropertiesAutoConfiguration.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> EnableAutoConfiguration Auto-configuration} for {<span class="doctag">@link</span> ConfigurationProperties}</span></span><br><span class="line"><span class="comment"> * beans. Automatically binds and validates any bean annotated with</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@code</span> <span class="doctag">@ConfigurationProperties</span>}.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Stephane Nicoll</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.3.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> EnableConfigurationProperties</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ConfigurationProperties</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span> <span class="comment">// &lt;X&gt;</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigurationPropertiesAutoConfiguration</span> </span>{</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>çœ‹ï¼Œçœ‹çœ‹ï¼Œçœ‹çœ‹çœ‹ï¼Œ<code>&lt;X&gt;</code> å“Ÿ~</li>
</ul>
<h2>2.2 EnableConfigurationPropertiesImportSelector</h2>
<p><code>org.springframework.boot.context.properties.EnableConfigurationPropertiesImportSelector</code> ï¼Œå®ç° ImportSelector æ¥å£ï¼Œå¤„ç† <code>@EnableConfigurationProperties</code> æ³¨è§£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// EnableConfigurationPropertiesImportSelector.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] IMPORTS = {</span><br><span class="line">		ConfigurationPropertiesBeanRegistrar.class.getName(),</span><br><span class="line">		ConfigurationPropertiesBindingPostProcessorRegistrar.class.getName() };</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String[] selectImports(AnnotationMetadata metadata) {</span><br><span class="line">	<span class="keyword">return</span> IMPORTS;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>è¿”å›çš„ <code>IMPORTS</code> çš„æ˜¯ä¸¤ä¸ª ImportBeanDefinitionRegistrar å®ç°ç±»ã€‚åˆ†åˆ«æ˜¯ï¼š
<ul>
<li>ConfigurationPropertiesBeanRegistrar ï¼Œåœ¨ <a href="#">ã€Œ2.3 ConfigurationPropertiesBeanRegistrarã€</a> ä¸­è¯¦ç»†è§£æã€‚</li>
<li>ConfigurationPropertiesBindingPostProcessorRegistrar ï¼Œåœ¨ <a href="#">ã€Œ2.4 ConfigurationPropertiesBindingPostProcessorRegistrarã€</a> ä¸­è¯¦ç»†è§£æã€‚</li>
</ul>
</li>
</ul>
<h2>2.3 ConfigurationPropertiesBeanRegistrar</h2>
<p>ConfigurationPropertiesBeanRegistrar ï¼Œæ˜¯ EnableConfigurationPropertiesImportSelector çš„å†…éƒ¨é™æ€ç±»ï¼Œå®ç° ImportBeanDefinitionRegistrar æ¥å£ï¼Œå°† <code>@EnableConfigurationProperties</code> æ³¨è§£æŒ‡å®šçš„ç±»ï¼Œé€ä¸ªæ³¨å†Œæˆå¯¹åº”çš„ BeanDefinition å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// EnableConfigurationPropertiesImportSelector#ConfigurationPropertiesBeanRegistrar.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> </span>{</span><br><span class="line">    getTypes(metadata) <span class="comment">// &lt;1&gt;</span></span><br><span class="line">            .forEach((type) -&gt; register(registry, (ConfigurableListableBeanFactory) registry, type)); <span class="comment">// &lt;2&gt;</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>
<p><code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#getTypes(AnnotationMetadata metadata)</code> æ–¹æ³•ï¼Œè·å¾— <code>@EnableConfigurationProperties</code> æ³¨è§£æŒ‡å®šçš„ç±»çš„æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š
</p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// EnableConfigurationPropertiesImportSelector#ConfigurationPropertiesBeanRegistrar.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> List&lt;Class&lt;?&gt;&gt; getTypes(AnnotationMetadata metadata) {</span><br><span class="line">    <span class="comment">// è·å¾— @EnableConfigurationProperties æ³¨è§£</span></span><br><span class="line">    MultiValueMap&lt;String, Object&gt; attributes = metadata.getAllAnnotationAttributes(EnableConfigurationProperties.class.getName(), <span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">// è·å¾— value å±æ€§</span></span><br><span class="line">    <span class="keyword">return</span> collectClasses((attributes != <span class="keyword">null</span>) ? attributes.get(<span class="string">"value"</span>)</span><br><span class="line">            : Collections.emptyList());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> List&lt;Class&lt;?&gt;&gt; collectClasses(List&lt;?&gt; values) {</span><br><span class="line">    <span class="keyword">return</span> values.stream().flatMap((value) -&gt; Arrays.stream((Object[]) value))</span><br><span class="line">            .map((o) -&gt; (Class&lt;?&gt;) o).filter((type) -&gt; <span class="keyword">void</span>.class != type)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>~</li>
</ul>
</li>
<li>
<p><code>&lt;2&gt;</code> å¤„ï¼Œéå†ï¼Œé€ä¸ªè°ƒç”¨ <code>#register(BeanDefinitionRegistry registry, ConfigurableListableBeanFactory beanFactory, Class&lt;?&gt; type)</code> æ–¹æ³•ï¼Œæ³¨å†Œæ¯ä¸ªç±»å¯¹åº”çš„ BeanDefinition å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// EnableConfigurationPropertiesImportSelector#ConfigurationPropertiesBeanRegistrar.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(BeanDefinitionRegistry registry, ConfigurableListableBeanFactory beanFactory, Class&lt;?&gt; type)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;2.1&gt; é€šè¿‡ @ConfigurationProperties æ³¨è§£ï¼Œè·å¾—æœ€åè¦ç”Ÿæˆçš„ BeanDefinition çš„åå­—ã€‚æ ¼å¼ä¸º prefix-ç±»å…¨å or ç±»å…¨å</span></span><br><span class="line">    String name = getName(type);</span><br><span class="line">    <span class="comment">// &lt;2.2&gt; åˆ¤æ–­æ˜¯å¦å·²ç»æœ‰è¯¥åå­—çš„ BeanDefinition çš„åå­—ã€‚æ²¡æœ‰ï¼Œæ‰è¿›è¡Œæ³¨å†Œ</span></span><br><span class="line">    <span class="keyword">if</span> (!containsBeanDefinition(beanFactory, name)) {</span><br><span class="line">        registerBeanDefinition(registry, name, type); <span class="comment">// &lt;2.3&gt; </span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>
<p><code>&lt;2.1&gt;</code> å¤„ï¼Œè°ƒç”¨  <code>#getName(Class&lt;?&gt; type)</code> æ–¹æ³•ï¼Œé€šè¿‡ <code>@ConfigurationProperties</code> æ³¨è§£ï¼Œè·å¾—æœ€åè¦ç”Ÿæˆçš„ BeanDefinition çš„åå­—ã€‚ä»£ç å¦‚ä¸‹ï¼š
</p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// EnableConfigurationPropertiesImportSelector#ConfigurationPropertiesBeanRegistrar.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getName</span><span class="params">(Class&lt;?&gt; type)</span> </span>{</span><br><span class="line">    ConfigurationProperties annotation = AnnotationUtils.findAnnotation(type, ConfigurationProperties.class);</span><br><span class="line">    String prefix = (annotation != <span class="keyword">null</span>) ? annotation.prefix() : <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">return</span> (StringUtils.hasText(prefix) ? prefix + <span class="string">"-"</span> + type.getName() : type.getName());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>æ ¼å¼ä¸º <code>prefix-</code>ç±»å…¨å or ç±»å…¨åã€‚</li>
</ul>
</li>
<li>
<p><code>&lt;2.2&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#containsBeanDefinition(ConfigurableListableBeanFactory beanFactory, String name)</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦å·²ç»æœ‰è¯¥åå­—çš„ BeanDefinition çš„åå­—ã€‚ä»£ç å¦‚ä¸‹ï¼š
</p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// EnableConfigurationPropertiesImportSelector#ConfigurationPropertiesBeanRegistrar.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">containsBeanDefinition</span><span class="params">(ConfigurableListableBeanFactory beanFactory, String name)</span> </span>{</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦å­˜åœ¨ BeanDefinition ã€‚å¦‚æœæœ‰ï¼Œåˆ™è¿”å› true</span></span><br><span class="line">    <span class="keyword">if</span> (beanFactory.containsBeanDefinition(name)) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// è·å¾—çˆ¶å®¹å™¨ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    BeanFactory parent = beanFactory.getParentBeanFactory();</span><br><span class="line">    <span class="keyword">if</span> (parent <span class="keyword">instanceof</span> ConfigurableListableBeanFactory) {</span><br><span class="line">        <span class="keyword">return</span> containsBeanDefinition((ConfigurableListableBeanFactory) parent, name);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// è¿”å› false ï¼Œè¯´æ˜ä¸å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>å¦‚æœä¸å­˜åœ¨ï¼Œæ‰æ‰§è¡Œåç»­çš„æ³¨å†Œ BeanDefinition é€»è¾‘ã€‚</li>
</ul>
</li>
<li>
<p><code>&lt;2.3&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#registerBeanDefinition(BeanDefinitionRegistry registry, String name, Class&lt;?&gt; type)</code> æ–¹æ³•ï¼Œæ³¨å†Œ BeanDefinition ã€‚ä»£ç å¦‚ä¸‹ï¼š
</p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// EnableConfigurationPropertiesImportSelector#ConfigurationPropertiesBeanRegistrar.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(BeanDefinitionRegistry registry, String name, Class&lt;?&gt; type)</span> </span>{</span><br><span class="line">    <span class="comment">// æ–­è¨€ï¼Œåˆ¤æ–­è¯¥ç±»æœ‰ @ConfigurationProperties æ³¨è§£</span></span><br><span class="line">    assertHasAnnotation(type);</span><br><span class="line">    <span class="comment">// åˆ›å»º GenericBeanDefinition å¯¹è±¡</span></span><br><span class="line">    GenericBeanDefinition definition = <span class="keyword">new</span> GenericBeanDefinition();</span><br><span class="line">    definition.setBeanClass(type);</span><br><span class="line">    <span class="comment">// æ³¨å†Œåˆ° BeanDefinitionRegistry ä¸­</span></span><br><span class="line">    registry.registerBeanDefinition(name, definition);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">assertHasAnnotation</span><span class="params">(Class&lt;?&gt; type)</span> </span>{</span><br><span class="line">    Assert.notNull(</span><br><span class="line">            AnnotationUtils.findAnnotation(type, ConfigurationProperties.class),</span><br><span class="line">            () -&gt; <span class="string">"No "</span> + ConfigurationProperties.class.getSimpleName()</span><br><span class="line">                    + <span class="string">" annotation found on  '"</span> + type.getName() + <span class="string">"'."</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>~</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2>2.4 ConfigurationPropertiesBindingPostProcessorRegistrar</h2>
<p><code>org.springframework.boot.context.properties.ConfigurationPropertiesBindingPostProcessorRegistrar</code> ï¼Œå®ç° ImportBeanDefinitionRegistrar æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBindingPostProcessorRegistrar.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (!registry.containsBeanDefinition(ConfigurationPropertiesBindingPostProcessor.BEAN_NAME)) {</span><br><span class="line">        <span class="comment">// &lt;1&gt; æ³¨å†Œ ConfigurationPropertiesBindingPostProcessor BeanDefinition</span></span><br><span class="line">        registerConfigurationPropertiesBindingPostProcessor(registry);</span><br><span class="line">        <span class="comment">// &lt;2&gt; æ³¨å†Œ ConfigurationBeanFactoryMetadata BeanDefinition</span></span><br><span class="line">        registerConfigurationBeanFactoryMetadata(registry);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>
<p><code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#registerConfigurationPropertiesBindingPostProcessor(BeanDefinitionRegistry registry)</code> æ–¹æ³•ï¼Œæ³¨å†Œ ConfigurationPropertiesBindingPostProcessor BeanDefinition ã€‚ä»£ç å¦‚ä¸‹ï¼š
</p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBindingPostProcessorRegistrar.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerConfigurationPropertiesBindingPostProcessor</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>{</span><br><span class="line">    <span class="comment">// åˆ›å»º GenericBeanDefinition å¯¹è±¡</span></span><br><span class="line">    GenericBeanDefinition definition = <span class="keyword">new</span> GenericBeanDefinition();</span><br><span class="line">    definition.setBeanClass(ConfigurationPropertiesBindingPostProcessor.class);</span><br><span class="line">    definition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    <span class="comment">// æ³¨å†Œ</span></span><br><span class="line">    registry.registerBeanDefinition(ConfigurationPropertiesBindingPostProcessor.BEAN_NAME, definition);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>å…³äº ConfigurationPropertiesBindingPostProcessor ç±»ï¼Œæˆ‘ä»¬åœ¨ <a href="#">ã€Œ4. ConfigurationPropertiesBindingPostProcessor ç›¸å…³ã€</a> ä¸­ï¼Œè¯¦ç»†è§£æã€‚</li>
</ul>
</li>
<li>
<p><code>&lt;2&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#registerConfigurationBeanFactoryMetadata(BeanDefinitionRegistry registry)</code> æ–¹æ³•ï¼Œæ³¨å†Œ ConfigurationBeanFactoryMetadata BeanDefinition ã€‚ä»£ç å¦‚ä¸‹ï¼š
</p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBindingPostProcessorRegistrar.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerConfigurationBeanFactoryMetadata</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>{</span><br><span class="line">    <span class="comment">// åˆ›å»º GenericBeanDefinition å¯¹è±¡</span></span><br><span class="line">    GenericBeanDefinition definition = <span class="keyword">new</span> GenericBeanDefinition();</span><br><span class="line">    definition.setBeanClass(ConfigurationBeanFactoryMetadata.class);</span><br><span class="line">    definition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    <span class="comment">// æ³¨å†Œ</span></span><br><span class="line">    registry.registerBeanDefinition(ConfigurationBeanFactoryMetadata.BEAN_NAME, definition);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>å…³äº ConfigurationBeanFactoryMetadata ç±»ï¼Œæˆ‘ä»¬åœ¨ <a href="#">ã€Œ3. ConfigurationBeanFactoryMetadataã€</a> ä¸­ï¼Œè¯¦ç»†è§£æã€‚</li>
</ul>
</li>
</ul>
<h1>3. ConfigurationBeanFactoryMetadata</h1>
<p><code>org.springframework.boot.context.properties.ConfigurationBeanFactoryMetadata</code> ï¼Œåˆå§‹åŒ–é…ç½®ç±»åˆ›å»º Bean çš„æ¯ä¸ªæ–¹æ³•çš„å…ƒæ•°æ®ã€‚</p>
<h2>3.1 postProcessBeanFactory</h2>
<p>å®ç° <code>#postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationBeanFactoryMetadata.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ConfigurableListableBeanFactory beanFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * FactoryMetadata çš„æ˜ å°„</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * KEY ï¼šBean çš„åå­—</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, FactoryMetadata&gt; beansFactoryMetadata = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; åˆå§‹åŒ– beanFactory å±æ€§</span></span><br><span class="line">    <span class="keyword">this</span>.beanFactory = beanFactory;</span><br><span class="line">    <span class="comment">// &lt;2&gt; éå†æ‰€æœ‰çš„ BeanDefinition çš„åå­—ä»¬</span></span><br><span class="line">    <span class="keyword">for</span> (String name : beanFactory.getBeanDefinitionNames()) {</span><br><span class="line">        <span class="comment">// &lt;2.1&gt; è·å¾— BeanDefinition å¯¹è±¡</span></span><br><span class="line">        BeanDefinition definition = beanFactory.getBeanDefinition(name);</span><br><span class="line">        <span class="comment">// &lt;2.2&gt; è·å¾— methodã€bean å±æ€§</span></span><br><span class="line">        String method = definition.getFactoryMethodName();</span><br><span class="line">        String bean = definition.getFactoryBeanName();</span><br><span class="line">        <span class="comment">// &lt;2.3&gt; æ·»åŠ åˆ° beansFactoryMetadata ä¸­</span></span><br><span class="line">        <span class="keyword">if</span> (method != <span class="keyword">null</span> &amp;&amp; bean != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">this</span>.beansFactoryMetadata.put(name, <span class="keyword">new</span> FactoryMetadata(bean, method));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>
<p><code>&lt;1&gt;</code> å¤„ï¼Œåˆå§‹åŒ– <code>beanFactory</code> å±æ€§ã€‚</p>
</li>
<li>
<p><code>&lt;2&gt;</code> å¤„ï¼Œéå†æ‰€æœ‰çš„ BeanDefinition çš„åå­—ä»¬ï¼Œåˆå§‹åŒ– <code>beansFactoryMetadata</code> å±æ€§ã€‚</p>
</li>
<li>
<p><code>&lt;2.1&gt;</code> å¤„ï¼Œè·å¾— BeanDefinition å¯¹è±¡ã€‚</p>
</li>
<li>
<p><code>&lt;2.2&gt;</code> å¤„ï¼Œè·å¾— BeanDefinition çš„ <code>factoryMethodName</code>ã€<code>factoryBeanName</code> å±æ€§ã€‚</p>
<ul>
<li>
<p><code>factoryBeanName</code> å±æ€§ï¼Œæ˜¯åˆ›å»ºè¯¥ Bean çš„å·¥å‚ Bean çš„åå­—ã€‚</p>
</li>
<li>
<p><code>factoryMethodName</code> å±æ€§ï¼Œæ˜¯åˆ›å»º Bean çš„å·¥å‚ Bean çš„æ–¹æ³•åã€‚</p>
</li>
<li>
<p>ä»¥å¦‚ä¸‹çš„ Configuration ç±»ï¼Œä¸¾ä¸ªä¾‹å­ï¼š
</p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestConfiguration</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">testObject</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Object();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>æ¯ä¸ª <code>@Bean</code> æ³¨è§£çš„æ–¹æ³•ï¼Œéƒ½æ˜¯ä¸€ä¸ª <code>factoryBeanName</code> + <code>factoryMethodName</code> ã€‚</li>
<li><code>factoryBeanName</code> å±æ€§ï¼Œä¸º <code>"testConfiguration"</code> ã€‚</li>
<li><code>factoryMethodName</code> å±æ€§ï¼Œä¸º <code>"testObject"</code> ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>&lt;2.3&gt;</code> å¤„ï¼Œéƒ½éç©ºçš„æƒ…å†µä¸‹ï¼Œæ·»åŠ åˆ° <code>beansFactoryMetadata</code> ä¸­ã€‚</p>
</li>
<li>
<p>FactoryMetadata æ˜¯ ConfigurationBeanFactoryMetadata çš„å†…éƒ¨é™æ€ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š
</p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationBeanFactoryMetadata#FactoryMetadata.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryMetadata</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Bean çš„åå­—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String bean;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Bean çš„æ–¹æ³•å</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String method;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... çœç•¥ setting / getting  æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
</li>
</ul>
<h2>3.2 findFactoryMethod</h2>
<p><code>#findFactoryMethod(String beanName)</code> æ–¹æ³•ï¼Œè·å¾—æŒ‡å®š Bean çš„åˆ›å»ºæ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationBeanFactoryMetadata.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Method <span class="title">findFactoryMethod</span><span class="params">(String beanName)</span> </span>{</span><br><span class="line">    <span class="comment">// å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¿”å› null</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.beansFactoryMetadata.containsKey(beanName)) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">    AtomicReference&lt;Method&gt; found = <span class="keyword">new</span> AtomicReference&lt;&gt;(<span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// è·å¾— beanName å¯¹åº”çš„ FactoryMetadata å¯¹è±¡</span></span><br><span class="line">    FactoryMetadata metadata = <span class="keyword">this</span>.beansFactoryMetadata.get(beanName);</span><br><span class="line">    <span class="comment">// è·å¾—å¯¹åº”çš„å·¥å‚ç±»</span></span><br><span class="line">    Class&lt;?&gt; factoryType = <span class="keyword">this</span>.beanFactory.getType(metadata.getBean());</span><br><span class="line">    <span class="keyword">if</span> (ClassUtils.isCglibProxyClass(factoryType)) {</span><br><span class="line">        factoryType = factoryType.getSuperclass();</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// è·å¾—å¯¹åº”çš„å·¥å‚ç±»çš„æ–¹æ³•</span></span><br><span class="line">    String factoryMethod = metadata.getMethod();</span><br><span class="line">    ReflectionUtils.doWithMethods(factoryType, (method) -&gt; {</span><br><span class="line">        <span class="keyword">if</span> (method.getName().equals(factoryMethod)) {</span><br><span class="line">            found.compareAndSet(<span class="keyword">null</span>, method);</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">    <span class="keyword">return</span> found.get();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2>3.3 findFactoryAnnotation</h2>
<p><code>#findFactoryAnnotation(String beanName, Class&lt;A&gt; type)</code> æ–¹æ³•ï¼Œè·å¾—æŒ‡å®š Bean çš„åˆ›å»ºæ–¹æ³•ä¸Šçš„æ³¨è§£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationBeanFactoryMetadata.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;A extends Annotation&gt; <span class="function">A <span class="title">findFactoryAnnotation</span><span class="params">(String beanName, Class&lt;A&gt; type)</span> </span>{</span><br><span class="line">    <span class="comment">// è·å¾—æ–¹æ³•</span></span><br><span class="line">    Method method = findFactoryMethod(beanName);</span><br><span class="line">    <span class="comment">// è·å¾—æ³¨è§£</span></span><br><span class="line">    <span class="keyword">return</span> (method != <span class="keyword">null</span>) ? AnnotationUtils.findAnnotation(method, type) : <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2>3.4 getBeansWithFactoryAnnotation</h2>
<p><code>#getBeansWithFactoryAnnotation(Class&lt;A&gt; type)</code> æ–¹æ³•ï¼Œè·å¾— <code>beansFactoryMetadata</code> ä¸­çš„æ¯ä¸ª Bean çš„æ–¹æ³•ä¸Šçš„æŒ‡å®šæ³¨è§£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationBeanFactoryMetadata.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;A extends Annotation&gt; <span class="function">Map&lt;String, Object&gt; <span class="title">getBeansWithFactoryAnnotation</span><span class="params">(Class&lt;A&gt; type)</span> </span>{</span><br><span class="line">    Map&lt;String, Object&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">// éå† beansFactoryMetadata</span></span><br><span class="line">    <span class="keyword">for</span> (String name : <span class="keyword">this</span>.beansFactoryMetadata.keySet()) {</span><br><span class="line">        <span class="comment">// è·å¾—æ¯ä¸ª Bean çš„åˆ›å»ºæ–¹æ³•ä¸Šçš„æ³¨è§£</span></span><br><span class="line">        <span class="keyword">if</span> (findFactoryAnnotation(name, type) != <span class="keyword">null</span>) {</span><br><span class="line">            result.put(name, <span class="keyword">this</span>.beanFactory.getBean(name));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>ğŸ˜ˆ è‡³æ­¤ï¼Œæˆ‘ä»¬åŸºæœ¬èƒ½å¤Ÿæ˜ç™½ï¼ŒConfigurationBeanFactoryMetadata å°±æ˜¯æä¾›ä¸€äº›å…ƒæ•°æ®çš„ã€‚</p>
<h1>4. ConfigurationPropertiesBindingPostProcessor ç›¸å…³</h1>
<blockquote>
<p>è‰¿è‰¿ï¼šå› ä¸º ConfigurationPropertiesBindingPostProcessor æ¶‰åŠåˆ°å¥½å‡ ä¸ªç±»ï¼Œæ‰€ä»¥ä¸€èµ·æ”¾åœ¨æœ¬å°èŠ‚æ¥çœ‹çœ‹ã€‚</p>
</blockquote>
<h2>4.1 ConfigurationPropertiesBindingPostProcessor</h2>
<p><code>org.springframework.boot.context.properties.ConfigurationPropertiesBindingPostProcessor</code> ï¼Œå®ç° BeanPostProcessorã€PriorityOrderedã€ApplicationContextAwareã€InitializingBean æ¥å£ï¼Œå°†é…ç½®æ–‡ä»¶æ³¨å…¥åˆ° <code>@ConfigurationProperties</code> æ³¨è§£çš„ Bean çš„å±æ€§ä¸­ã€‚</p>
<h3>4.1.1 åŸºæœ¬å±æ€§</h3>
<p></p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBindingPostProcessor.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The bean name of the configuration properties validator.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String VALIDATOR_BEAN_NAME = <span class="string">"configurationPropertiesValidator"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ConfigurationBeanFactoryMetadata beanFactoryMetadata;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ConfigurationPropertiesBinder configurationPropertiesBinder;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>{</span><br><span class="line">    <span class="keyword">this</span>.applicationContext = applicationContext; <span class="comment">// &lt;1&gt;</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="comment">// We can't use constructor injection of the application context because</span></span><br><span class="line">    <span class="comment">// it causes eager factory bean initialization</span></span><br><span class="line">    <span class="keyword">this</span>.beanFactoryMetadata = <span class="keyword">this</span>.applicationContext.getBean(ConfigurationBeanFactoryMetadata.BEAN_NAME, ConfigurationBeanFactoryMetadata.class); <span class="comment">// &lt;2&gt;</span></span><br><span class="line">    <span class="keyword">this</span>.configurationPropertiesBinder = <span class="keyword">new</span> ConfigurationPropertiesBinder(<span class="keyword">this</span>.applicationContext, VALIDATOR_BEAN_NAME); <span class="comment">// &lt;3&gt;</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œè®¾ç½® <code>applicationContext</code> å±æ€§ã€‚</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œè®¾ç½® <code>beanFactoryMetadata</code> å±æ€§ã€‚å³ï¼Œæˆ‘ä»¬åœ¨ <a href="#">ã€Œ3. ConfigurationBeanFactoryMetadataã€</a> ä¸­çœ‹åˆ°çš„ã€‚</li>
<li><code>&lt;3&gt;</code> å¤„ï¼Œåˆ›å»º ConfigurationPropertiesBinder å¯¹è±¡ï¼Œè®¾ç½®åˆ° <code>configurationPropertiesBinder</code> å±æ€§ã€‚TODO  ConfigurationPropertiesBinder</li>
</ul>
<h3>4.1.2 postProcessBeforeInitialization</h3>
<p>å®ç° <code>#postProcessBeforeInitialization(Object bean, String beanName)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBindingPostProcessor.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; è·å¾— Bean ä¸Šçš„ @ConfigurationProperties å±æ€§</span></span><br><span class="line">    ConfigurationProperties annotation = getAnnotation(bean, beanName, ConfigurationProperties.class);</span><br><span class="line">    <span class="keyword">if</span> (annotation != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="comment">// &lt;2&gt; å°†é…ç½®æ–‡ä»¶æ³¨å…¥åˆ° `@ConfigurationProperties` æ³¨è§£çš„ Bean çš„å±æ€§ä¸­</span></span><br><span class="line">        bind(bean, beanName, annotation);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#getAnnotation(Object bean, String beanName, Class&lt;A&gt; type)</code> æ–¹æ³•ï¼Œè·å¾— Bean ä¸Šçš„ <code>@ConfigurationProperties</code> å±æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBindingPostProcessor.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;A extends Annotation&gt; <span class="function">A <span class="title">getAnnotation</span><span class="params">(Object bean, String beanName, Class&lt;A&gt; type)</span> </span>{</span><br><span class="line">    <span class="comment">// è·å¾— Bean ä¸Šçš„æ³¨è§£</span></span><br><span class="line">    A annotation = <span class="keyword">this</span>.beanFactoryMetadata.findFactoryAnnotation(beanName, type);</span><br><span class="line">    <span class="comment">// å¦‚æœè·å¾—ä¸åˆ°ï¼Œåˆ™è·å¾— Bean å¯¹åº”çš„ Class ä¸Šçš„æ³¨è§£</span></span><br><span class="line">    <span class="keyword">if</span> (annotation == <span class="keyword">null</span>) {</span><br><span class="line">        annotation = AnnotationUtils.findAnnotation(bean.getClass(), type);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> annotation;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<ul>
<li>
<p><code>&lt;2&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#bind(Object bean, String beanName, ConfigurationProperties annotation)</code> æ–¹æ³•ï¼Œå°†é…ç½®æ–‡ä»¶æ³¨å…¥åˆ° <code>@ConfigurationProperties</code> æ³¨è§£çš„ Bean çš„å±æ€§ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š
</p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBindingPostProcessor.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(Object bean, String beanName, ConfigurationProperties annotation)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;2.1&gt; è§£æ Bean çš„ç±»å‹</span></span><br><span class="line">    ResolvableType type = getBeanType(bean, beanName);</span><br><span class="line">    <span class="comment">// &lt;2.2&gt; è·å¾— Bean ä¸Šçš„ @Validated æ³¨è§£</span></span><br><span class="line">    Validated validated = getAnnotation(bean, beanName, Validated.class);</span><br><span class="line">    <span class="comment">// &lt;2.3&gt; åˆ›å»º Annotation æ•°ç»„</span></span><br><span class="line">    Annotation[] annotations = (validated != <span class="keyword">null</span>)</span><br><span class="line">            ? <span class="keyword">new</span> Annotation[] { annotation, validated }</span><br><span class="line">            : <span class="keyword">new</span> Annotation[] { annotation };</span><br><span class="line">    <span class="comment">// &lt;2.4&gt; åˆ›å»º Bindable å¯¹è±¡</span></span><br><span class="line">    Bindable&lt;?&gt; target = Bindable.of(type).withExistingValue(bean).withAnnotations(annotations);</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// &lt;2.5&gt; å°†é…ç½®æ–‡ä»¶æ³¨å…¥åˆ° `@ConfigurationProperties` æ³¨è§£çš„ Bean çš„å±æ€§ä¸­</span></span><br><span class="line">        <span class="keyword">this</span>.configurationPropertiesBinder.bind(target);</span><br><span class="line">    } <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationPropertiesBindException(beanName, bean, annotation, ex);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>
<p><code>&lt;2.1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#getBeanType(Object bean, String beanName)</code> æ–¹æ³•ï¼Œè§£æ Bean çš„ç±»å‹ã€‚ä»£ç å¦‚ä¸‹ï¼š
</p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBindingPostProcessor.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> ResolvableType <span class="title">getBeanType</span><span class="params">(Object bean, String beanName)</span> </span>{</span><br><span class="line">    <span class="comment">// è·å¾— beanName å¯¹åº”çš„å·¥å‚æ–¹æ³•</span></span><br><span class="line">    Method factoryMethod = <span class="keyword">this</span>.beanFactoryMetadata.findFactoryMethod(beanName);</span><br><span class="line">    <span class="comment">// æƒ…å†µä¸€ï¼šå¦‚æœæ˜¯ï¼Œè¯´æ˜æ˜¯ Configuration ç±»åˆ›å»ºçš„ Bean å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (factoryMethod != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> ResolvableType.forMethodReturnType(factoryMethod);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// æƒ…å†µäºŒï¼šå¦‚æœå¦ï¼Œè¯´æ˜æ˜¯æ™®é€šçš„ç±»åˆ›å»ºçš„ Bean å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> ResolvableType.forClass(bean.getClass());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>ä¸¤ç§æƒ…å†µï¼Œè§æ³¨é‡Šã€‚</li>
</ul>
</li>
<li>
<p><code>&lt;2.2&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#getAnnotation(Object bean, String beanName, Class&lt;A&gt; type)</code> æ–¹æ³•ï¼Œè·å¾— Bean ä¸Šçš„ <code>@Validated</code> å±æ€§ã€‚<code>@ConfigurationProperties</code> æ³¨è§£ï¼Œå¯ä»¥é…åˆ <code>@Validated</code> æ³¨è§£ï¼Œä¸€èµ·ä½¿ç”¨ï¼Œä»è€Œå®ç°æ ¡éªŒçš„åŠŸèƒ½ã€‚å…·ä½“å¯ä»¥çœ‹çœ‹ <a href="https://github.com/spring-projects/spring-boot/issues/10803" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠEnable <code>ConfigurationProperties</code> validation with <code>@Validated</code> on the factory methodã€‹</a> æ–‡ç« ã€‚</p>
</li>
<li>
<p><code>&lt;2.3&gt;</code> å¤„ï¼Œåˆ›å»º Annotation æ•°ç»„ã€‚</p>
</li>
<li>
<p><code>&lt;2.4&gt;</code> å¤„ï¼Œåˆ›å»º Bindable å¯¹è±¡ã€‚æˆ‘ä»¬å…ˆä¸ç”¨å»ç†è§£ Bindable æ˜¯ä¸ªé”¤å­ï¼Œè‡³å°‘æˆ‘ä»¬çœ‹åˆ°äº† <code>withExistingValue(bean)</code> è®¾ç½®äº† Bean å¯¹è±¡ï¼Œ<code>withAnnotations(annotations)</code> è®¾ç½®äº† Annotation æ³¨è§£æ•°ç»„ã€‚</p>
</li>
<li>
<p><code>&lt;2.5&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>ConfigurationPropertiesBinder#bind(Bindable&lt;?&gt; target)</code> æ–¹æ³•ï¼Œå°†é…ç½®æ–‡ä»¶æ³¨å…¥åˆ° <code>@ConfigurationProperties</code> æ³¨è§£çš„ Bean çš„å±æ€§ä¸­ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ4.2 ConfigurationPropertiesBinderã€</a> ã€‚</p>
</li>
</ul>
</li>
</ul>
<h2>4.2 ConfigurationPropertiesBinder</h2>
<p><code>org.springframework.boot.context.properties.ConfigurationPropertiesBinder</code> ï¼Œå¤„ç† <code>@ConfigurationProperties</code> æ³¨è§£çš„ Bean çš„å±æ€§çš„æ³¨å…¥ã€‚å…¶ç±»ä¸Šçš„æ³¨é‡Šå¦‚ä¸‹ï¼š</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBinder.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Internal class by the {<span class="doctag">@link</span> ConfigurationPropertiesBindingPostProcessor} to handle the</span></span><br><span class="line"><span class="comment"> * actual {<span class="doctag">@link</span> ConfigurationProperties} binding.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<h3>4.2.1 æ„é€ æ–¹æ³•</h3>
<p></p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBinder.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PropertySources propertySources;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Validator configurationPropertiesValidator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> jsr303Present;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Validator jsr303Validator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Binder binder;</span><br><span class="line"></span><br><span class="line">ConfigurationPropertiesBinder(ApplicationContext applicationContext, String validatorBeanName) {</span><br><span class="line">	<span class="keyword">this</span>.applicationContext = applicationContext; <span class="comment">// &lt;1&gt;</span></span><br><span class="line">	<span class="keyword">this</span>.propertySources = <span class="keyword">new</span> PropertySourcesDeducer(applicationContext).getPropertySources(); <span class="comment">// &lt;2&gt;</span></span><br><span class="line">	<span class="keyword">this</span>.configurationPropertiesValidator = getConfigurationPropertiesValidator(applicationContext, validatorBeanName); <span class="comment">// &lt;3&gt; </span></span><br><span class="line">	<span class="keyword">this</span>.jsr303Present = ConfigurationPropertiesJsr303Validator.isJsr303Present(applicationContext); <span class="comment">// &lt;4&gt;</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>
<p><code>&lt;1&gt;</code> å¤„ï¼Œè®¾ç½® <code>applicationContext</code> å±æ€§ã€‚</p>
</li>
<li>
<p><code>&lt;2&gt;</code> å¤„ï¼Œåˆ›å»º <a href="https://github.com/YunaiV/spring-boot/blob/master/spring-boot-project/spring-boot/src/main/java/org/springframework/boot/context/properties/PropertySourcesDeducer.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.springframework.boot.context.properties.PropertySourcesDeducer</code></a> å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ <code>PropertySourcesDeducer#getPropertySources()</code> æ–¹æ³•ï¼Œè·å¾— PropertySource æ•°ç»„ï¼Œä¹‹åè®¾ç½®ç»™ <code>propertySources</code> å±æ€§ã€‚å…³äº PropertySourcesDeducer.java ç±»ï¼Œèƒ–å‹ç‚¹å‡»é“¾æ¥ï¼Œè‡ªå·±çœ‹çœ‹å³å¯ã€‚</p>
</li>
<li>
<p><code>&lt;3&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#getConfigurationPropertiesValidator(ApplicationContext applicationContext, String validatorBeanName)</code> æ–¹æ³•ï¼Œè·å¾—é…ç½®çš„ Validator å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š
</p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBinder.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Validator <span class="title">getConfigurationPropertiesValidator</span><span class="params">(ApplicationContext applicationContext, String validatorBeanName)</span> </span>{</span><br><span class="line">	<span class="keyword">if</span> (applicationContext.containsBean(validatorBeanName)) {</span><br><span class="line">		<span class="keyword">return</span> applicationContext.getBean(validatorBeanName, Validator.class);</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>ä»ä¸Šé¢çš„æ–‡ç« ï¼Œå¯ä»¥çŸ¥é“ <code>validatorBeanName</code> ä¸º <code>"configurationPropertiesValidator"</code> ã€‚å³ï¼Œåˆ›å»ºçš„ Validator Bean çš„å¯¹è±¡ã€‚</li>
<li>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸ä¼šé…ç½®è¯¥ Bean å¯¹è±¡ï¼Œæ‰€ä»¥è¿”å› <code>null</code> ã€‚å› æ­¤å§ï¼Œå¯ä»¥æš‚æ—¶æ— è§†è¿™ä¸ª <code>configurationPropertiesValidator</code> å±æ€§~ã€‚</li>
</ul>
</li>
<li>
<p><code>&lt;4&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>ConfigurationPropertiesJsr303Validator#isJsr303Present(ApplicationContext applicationContext)</code> æ–¹æ³•ï¼Œæ˜¯å¦æœ‰å¼•å…¥ Jsr 303 Validator ç›¸å…³çš„ä¾èµ–ã€‚å…³äºå®ƒï¼Œè¯¦ç»†è§£æè§ <a href="#">ã€Œ4.3 ConfigurationPropertiesJsr303Validatorã€</a> ä¸­ã€‚</p>
</li>
</ul>
<h3>4.2.2 bind</h3>
<p><code>#bind(Bindable&lt;?&gt; target)</code> æ–¹æ³•ï¼Œå¤„ç† <code>@ConfigurationProperties</code> æ³¨è§£çš„ Bean çš„å±æ€§çš„æ³¨å…¥ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBinder.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(Bindable&lt;?&gt; target)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; è·å¾— @ConfigurationProperties æ³¨è§£çš„å±æ€§</span></span><br><span class="line">    ConfigurationProperties annotation = target.getAnnotation(ConfigurationProperties.class);</span><br><span class="line">    Assert.state(annotation != <span class="keyword">null</span>, () -&gt; <span class="string">"Missing @ConfigurationProperties on "</span> + target);</span><br><span class="line">    <span class="comment">// &lt;2&gt; è·å¾— Validator æ•°ç»„</span></span><br><span class="line">    List&lt;Validator&gt; validators = getValidators(target);</span><br><span class="line">    <span class="comment">// &lt;3&gt; è·å¾— BindHandler å¯¹è±¡</span></span><br><span class="line">    BindHandler bindHandler = getBindHandler(annotation, validators);</span><br><span class="line">    <span class="comment">// &lt;4&gt; è·å¾— Binder å¯¹è±¡ï¼Œç„¶åæ‰§è¡Œç»‘å®šé€»è¾‘ï¼Œå¤„ç† `@ConfigurationProperties` æ³¨è§£çš„ Bean çš„å±æ€§çš„æ³¨å…¥</span></span><br><span class="line">    getBinder().bind(annotation.prefix(), target, bindHandler);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>
<p><code>&lt;1&gt;</code> å¤„ï¼Œè·å¾— <code>@ConfigurationProperties</code> æ³¨è§£çš„å±æ€§ã€‚</p>
</li>
<li>
<p><code>&lt;2&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#getValidators(Bindable&lt;?&gt; target)</code> æ–¹æ³•ï¼Œè·å¾— Validator æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š
</p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBinder.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;Validator&gt; <span class="title">getValidators</span><span class="params">(Bindable&lt;?&gt; target)</span> </span>{</span><br><span class="line">    List&lt;Validator&gt; validators = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">3</span>);</span><br><span class="line">    <span class="comment">// æ¥æºä¸€ï¼ŒconfigurationPropertiesValidator</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.configurationPropertiesValidator != <span class="keyword">null</span>) {</span><br><span class="line">        validators.add(<span class="keyword">this</span>.configurationPropertiesValidator);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// æ¥æºäºŒï¼ŒConfigurationPropertiesJsr303Validator å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.jsr303Present &amp;&amp; target.getAnnotation(Validated.class) != <span class="keyword">null</span>) {</span><br><span class="line">        validators.add(getJsr303Validator());</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// æ¥æºä¸‰ï¼Œè‡ªå·±å®ç°äº† Validator æ¥å£</span></span><br><span class="line">    <span class="keyword">if</span> (target.getValue() != <span class="keyword">null</span> &amp;&amp; target.getValue().get() <span class="keyword">instanceof</span> Validator) {</span><br><span class="line">        validators.add((Validator) target.getValue().get());</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> validators;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å› ConfigurationPropertiesJsr303Validator å¯¹è±¡</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Validator <span class="title">getJsr303Validator</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.jsr303Validator == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">this</span>.jsr303Validator = <span class="keyword">new</span> ConfigurationPropertiesJsr303Validator(<span class="keyword">this</span>.applicationContext);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.jsr303Validator;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>ä¸‰ä¸ªæ¥æºã€‚</li>
</ul>
</li>
<li>
<p><code>&lt;3&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#getBindHandler(ConfigurationProperties annotation, List&lt;Validator&gt; validators)</code> æ–¹æ³•ï¼Œè·å¾— BindHandler å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š
</p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBinder.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> BindHandler <span class="title">getBindHandler</span><span class="params">(ConfigurationProperties annotation, List&lt;Validator&gt; validators)</span> </span>{</span><br><span class="line">	BindHandler handler = <span class="keyword">new</span> IgnoreTopLevelConverterNotFoundBindHandler();</span><br><span class="line">	<span class="comment">// å¦‚æœæœ‰ ignoreInvalidFields å±æ€§ï¼Œè¿›ä¸€æ­¥åŒ…è£…æˆ IgnoreErrorsBindHandler ç±»</span></span><br><span class="line">	<span class="keyword">if</span> (annotation.ignoreInvalidFields()) {</span><br><span class="line">		handler = <span class="keyword">new</span> IgnoreErrorsBindHandler(handler);</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// å¦‚æœå¦ ignoreUnknownFields å±æ€§ï¼Œè¿›ä¸€æ­¥åŒ…è£…æˆ NoUnboundElementsBindHandler ç±»</span></span><br><span class="line">	<span class="keyword">if</span> (!annotation.ignoreUnknownFields()) {</span><br><span class="line">		UnboundElementsSourceFilter filter = <span class="keyword">new</span> UnboundElementsSourceFilter();</span><br><span class="line">		handler = <span class="keyword">new</span> NoUnboundElementsBindHandler(handler, filter);</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// &lt;X&gt; å¦‚æœ Validator æ•°ç»„éç©ºï¼Œè¿›ä¸€æ­¥åŒ…è£…æˆ ValidationBindHandler å¯¹è±¡</span></span><br><span class="line">	<span class="keyword">if</span> (!validators.isEmpty()) {</span><br><span class="line">		handler = <span class="keyword">new</span> ValidationBindHandler(handler, validators.toArray(<span class="keyword">new</span> Validator[<span class="number">0</span>]));</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// &lt;Y&gt; å¦‚æœæœ‰ ConfigurationPropertiesBindHandlerAdvisor å…ƒç´ ï¼Œåˆ™è¿›ä¸€æ­¥å¤„ç† handler å¯¹è±¡</span></span><br><span class="line">	<span class="keyword">for</span> (ConfigurationPropertiesBindHandlerAdvisor advisor : getBindHandlerAdvisors()) {</span><br><span class="line">		handler = advisor.apply(handler);</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> handler;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;ConfigurationPropertiesBindHandlerAdvisor&gt; <span class="title">getBindHandlerAdvisors</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.applicationContext.getBeanProvider(ConfigurationPropertiesBindHandlerAdvisor.class)</span><br><span class="line">			.orderedStream().collect(Collectors.toList());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li><code>&lt;X&gt;</code> å¤„ï¼Œé€šè¿‡å°† <code>handler</code> åŒ…è£…æˆ ValidationBindHandler å¯¹è±¡ï¼Œä»è€Œå®ç° Validator åŠŸèƒ½çš„æä¾›ã€‚</li>
<li><code>&lt;Y&gt;</code> å¤„ï¼Œæ­¤å¤„çš„ <a href="https://github.com/YunaiV/spring-boot/blob/master/spring-boot-project/spring-boot/src/main/java/org/springframework/boot/context/properties/ConfigurationPropertiesBindHandlerAdvisor.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.springframework.boot.context.properties.ConfigurationPropertiesBindHandlerAdvisor</code></a> æ¥å£ï¼Œé€šè¿‡å®ç°å®ƒï¼Œå¹¶æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­ï¼Œå¯ä»¥å¯¹ <code>handler</code> è¿›ä¸€æ­¥å¤„ç†ã€‚ğŸ˜ˆ å½“ç„¶ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒåŒ…æ‹¬ Spring Boot ä¹Ÿå¹¶æœªæä¾›å…¶å®ç°ï¼Œæˆ‘ä»¬ä¸éœ€è¦è¿™ä¹ˆåšã€‚æ‰€ä»¥å‘¢ï¼Œè¿™å—æˆ‘ä»¬åˆå¯ä»¥æ— è§†è½ã€‚</li>
<li>ğŸ™‚ å¦å¤–ï¼Œå…³äº BindHandler æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬å…ˆä¸ç”¨å»ç ”ç©¶ã€‚åç»­ï¼Œæˆ‘ä»¬æ”¾åœ¨å¦å¤–çš„æ–‡ç« ï¼Œæ¥æ…¢æ…¢è®²è§£~</li>
</ul>
</li>
<li>
<p><code>&lt;4&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#getBinder()</code> æ–¹æ³•ï¼Œè·å¾— Binder å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š
</p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBinder.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Binder <span class="title">getBinder</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.binder == <span class="keyword">null</span>) {</span><br><span class="line">	    <span class="comment">// åˆ›å»º Binder å¯¹è±¡</span></span><br><span class="line">		<span class="keyword">this</span>.binder = <span class="keyword">new</span> Binder(getConfigurationPropertySources(),</span><br><span class="line">				getPropertySourcesPlaceholdersResolver(),</span><br><span class="line">                getConversionService(),</span><br><span class="line">				getPropertyEditorInitializer());</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.binder;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Iterable&lt;ConfigurationPropertySource&gt; <span class="title">getConfigurationPropertySources</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> ConfigurationPropertySources.from(<span class="keyword">this</span>.propertySources);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> PropertySourcesPlaceholdersResolver <span class="title">getPropertySourcesPlaceholdersResolver</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> PropertySourcesPlaceholdersResolver(<span class="keyword">this</span>.propertySources);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> ConversionService <span class="title">getConversionService</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> ConversionServiceDeducer(<span class="keyword">this</span>.applicationContext).getConversionService(); <span class="comment">// &lt;X&gt;</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Consumer&lt;PropertyEditorRegistry&gt; <span class="title">getPropertyEditorInitializer</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.applicationContext <span class="keyword">instanceof</span> ConfigurableApplicationContext) {</span><br><span class="line">		<span class="keyword">return</span> ((ConfigurableApplicationContext) <span class="keyword">this</span>.applicationContext).getBeanFactory()::copyRegisteredEditorsTo;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li><code>&lt;X&gt;</code> å¤„ï¼Œåˆ›å»º ConversionServiceDeducer åˆ›å»ºï¼Œç„¶åè°ƒç”¨ <code>ConversionServiceDeducer#getConversionService()</code> æ–¹æ³•ï¼Œè·å¾— ConversionService å¯¹è±¡ã€‚ConversionService æ˜¯ Spring ä¸­ï¼Œç”¨æ¥ä½œä¸ºç±»å‹è½¬æ¢å™¨çš„ã€‚å…³äº <a href="https://github.com/YunaiV/spring-boot/blob/master/spring-boot-project/spring-boot/src/main/java/org/springframework/boot/context/properties/ConversionServiceDeducer.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.springframework.boot.context.properties.ConversionServiceDeducer</code></a> ç±»ï¼Œèƒ–å‹ç‚¹å‡»é“¾æ¥ï¼Œç®€å•çœ‹çœ‹å³å¯ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä¸çœ‹~</li>
</ul>
</li>
<li>
<p><code>&lt;4&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>Binder#bind(String name, Bindable&lt;T&gt; target, BindHandler handler)</code> æ–¹æ³•ï¼Œæ‰§è¡Œç»‘å®šé€»è¾‘ï¼Œå¤„ç† <code>@ConfigurationProperties</code> æ³¨è§£çš„ Bean çš„å±æ€§çš„æ³¨å…¥ã€‚ğŸ˜ˆ è‡³æ­¤ï¼Œæ’’èŠ±~</p>
</li>
</ul>
<h2>4.3 ConfigurationPropertiesJsr303Validator</h2>
<p><code>org.springframework.boot.context.properties.ConfigurationPropertiesJsr303Validator</code> ï¼Œå®ç° Validator æ¥å£ï¼Œ<code>@ConfigurationProperties</code> + <code>@Validated</code> æ³¨è§£çš„ Bean çš„ JSR303 çš„ Validator å®ç°ç±»ã€‚å…¶ç±»ä¸Šçš„æ³¨é‡Šå¦‚ä¸‹ï¼š</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationPropertiesJsr303Validator.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Validator that supports configuration classes annotated with</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> Validated <span class="doctag">@Validated</span>}.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<h3>4.3.1 æ„é€ æ–¹æ³•</h3>
<p></p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationPropertiesJsr303Validator.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Delegate delegate;</span><br><span class="line"></span><br><span class="line">ConfigurationPropertiesJsr303Validator(ApplicationContext applicationContext) {</span><br><span class="line">	<span class="keyword">this</span>.delegate = <span class="keyword">new</span> Delegate(applicationContext);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Delegate</span> <span class="keyword">extends</span> <span class="title">LocalValidatorFactoryBean</span> </span>{</span><br><span class="line"></span><br><span class="line">    Delegate(ApplicationContext applicationContext) {</span><br><span class="line">        <span class="comment">// è®¾ç½® applicationContext å±æ€§</span></span><br><span class="line">        setApplicationContext(applicationContext);</span><br><span class="line">        <span class="comment">// è®¾ç½® messageInterpolator å±æ€§</span></span><br><span class="line">        setMessageInterpolator(<span class="keyword">new</span> MessageInterpolatorFactory().getObject());</span><br><span class="line">        <span class="comment">// å›è°ƒ afterPropertiesSet æ–¹æ³•</span></span><br><span class="line">        afterPropertiesSet();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<h3>4.3.2 isJsr303Present</h3>
<p><code>#isJsr303Present(ApplicationContext applicationContext)</code> æ–¹æ³•ï¼Œæ ¡éªŒæ˜¯å¦æ”¯æŒ JSR303 ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationPropertiesJsr303Validator.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] VALIDATOR_CLASSES = { <span class="string">"javax.validation.Validator"</span>,</span><br><span class="line">		<span class="string">"javax.validation.ValidatorFactory"</span>,</span><br><span class="line">		<span class="string">"javax.validation.bootstrap.GenericBootstrap"</span> };</span><br><span class="line">		</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isJsr303Present</span><span class="params">(ApplicationContext applicationContext)</span> </span>{</span><br><span class="line">	ClassLoader classLoader = applicationContext.getClassLoader();</span><br><span class="line">	<span class="keyword">for</span> (String validatorClass : VALIDATOR_CLASSES) {</span><br><span class="line">		<span class="keyword">if</span> (!ClassUtils.isPresent(validatorClass, classLoader)) {</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>é€šè¿‡åˆ¤æ–­ï¼Œæ˜¯å¦å¼•å…¥äº†ç›¸å…³çš„ä¾èµ–ã€‚</li>
</ul>
<h3>4.3.3 supports</h3>
<p>å®ç° <code>#supports(Class&lt;?&gt; type)</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦æ”¯æŒæŒ‡å®šç±»çš„æ ¡éªŒã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationPropertiesJsr303Validator.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; type)</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.delegate.supports(type);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<h3>4.3.4 validate</h3>
<p>å®ç° <code>#validate(Object target, Errors errors)</code> æ–¹æ³•ï¼Œæ‰§è¡Œæ ¡éªŒã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationPropertiesJsr303Validator.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validate</span><span class="params">(Object target, Errors errors)</span> </span>{</span><br><span class="line">	<span class="keyword">this</span>.delegate.validate(target, errors);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<h1>666. å½©è›‹</h1>
<p>å‘¼å‘¼ï¼Œç»ˆäºå†™äº†ä¸€ç¯‡ç›¸å¯¹çŸ­ä¸€ç‚¹çš„æ–‡ç« ï¼Œèˆ’æœ~å…³äºæœ¬æ–‡çœ‹åˆ°çš„ Binderã€BinderHandlerã€Bindable ç­‰ç­‰ç±»ï¼Œå±äº <code>org.springframework.boot.context.properties.bind</code> åŒ…ï¼Œåç»­æˆ‘ä»¬æ ¹æ®éœ€è¦ï¼Œä¼šå¯¹è¿™å—åœ¨è¿›è¡Œè¯¦ç»†çš„è§£æ~</p>
<p>å‚è€ƒå’Œæ¨èå¦‚ä¸‹æ–‡ç« ï¼š</p>
<ul>
<li>oldflame-Jm <a href="https://blog.csdn.net/jamet/article/details/78505703" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring bootæºç åˆ†æ-ConfigurationPropertiesã€‹</a></li>
<li>æ¢¦æƒ³2018 <a href="https://blog.csdn.net/ab411919134/article/details/81190425" rel="external nofollow noopener noreferrer" target="_blank">ã€Šspring @EnableConfigurationProperties å®ç°åŸç†ã€‹</a></li>
<li>ä¸€ä¸ªåŠªåŠ›çš„ç å†œ
<ul>
<li><a href="https://blog.csdn.net/qq_26000415/article/details/78942494" rel="external nofollow noopener noreferrer" target="_blank">ã€Šspring boot æºç è§£æ13-@ConfigurationPropertiesæ˜¯å¦‚ä½•ç”Ÿæ•ˆçš„ã€‹</a></li>
<li><a href="https://blog.csdn.net/qq_26000415/article/details/78947283" rel="external nofollow noopener noreferrer" target="_blank">ã€Šspring boot æºç è§£æ14-é»˜è®¤é”™è¯¯é¡µé¢å¤„ç†æµç¨‹, è‡ªå®šä¹‰,åŠEnableAutoConfigurationImportSelectorå¤„ç†ã€‹</a></li>
</ul>
</li>
</ul>




</div>