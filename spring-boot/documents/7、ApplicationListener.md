<div class="article-entry" itemprop="articleBody">

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ï¼Œæˆ‘ä»¬æ¥è¡¥å…… <a href="http://svip.iocoder.cn/Spring-Boot/SpringApplication">ã€Šç²¾å°½ Spring Boot æºç åˆ†æ â€”â€” SpringApplicationã€‹</a> æ–‡ç« ï¼Œå¹¶æœªè¯¦ç»†è§£æçš„ ApplicationListener ã€‚</p>
<h1 id="2-ApplicationListener"><a href="#2-ApplicationListener" class="headerlink" title="2. ApplicationListener"></a>2. ApplicationListener</h1><p><code>org.springframework.context.ApplicationListener</code> ï¼Œåº”ç”¨äº‹ä»¶ç›‘å¬å™¨æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Interface to be implemented by application event listeners.</span></span><br><span class="line"><span class="comment"> * Based on the standard {<span class="doctag">@code</span> java.util.EventListener} interface</span></span><br><span class="line"><span class="comment"> * for the Observer design pattern.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;As of Spring 3.0, an ApplicationListener can generically declare the event type</span></span><br><span class="line"><span class="comment"> * that it is interested in. When registered with a Spring ApplicationContext, events</span></span><br><span class="line"><span class="comment"> * will be filtered accordingly, with the listener getting invoked for matching event</span></span><br><span class="line"><span class="comment"> * objects only.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Rod Johnson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;E&gt; the specific ApplicationEvent subclass to listen to</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.context.event.ApplicationEventMulticaster</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationListener</span>&lt;<span class="title">E</span> <span class="keyword">extends</span> <span class="title">ApplicationEvent</span>&gt; <span class="keyword">extends</span> <span class="title">EventListener</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Handle an application event.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> event the event to respond to</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(E event)</span></span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¦‚æœå¯¹è¿™å—ä¸äº†è§£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ <a href="http://www.iocoder.cn/Spring/ApplicationContextEvent/?vip" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring 5 æºç è§£æ â€”â€” Spring æ¡†æ¶ä¸­çš„äº‹ä»¶å’Œç›‘å¬å™¨ã€‹</a> æ–‡ç« ã€‚</li>
</ul>
<h2 id="2-1-SmartApplicationListener"><a href="#2-1-SmartApplicationListener" class="headerlink" title="2.1 SmartApplicationListener"></a>2.1 SmartApplicationListener</h2><p><code>org.springframework.context.event.SmartApplicationListener</code> æ¥å£ï¼Œå®ç° ApplicationListenerã€Ordered æ¥å£ï¼Œæ˜¯ Spring3.0 æ–°å¢çš„æ¥å£ï¼Œæä¾›äº†äº‹ä»¶ç±»å‹å’Œæ¥æºçš„åˆ¤æ–­æ¥å£æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// SmartApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Extended variant of the standard {<span class="doctag">@link</span> ApplicationListener} interface,</span></span><br><span class="line"><span class="comment"> * exposing further metadata such as the supported event and source type.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;For full introspection of generic event types, consider implementing</span></span><br><span class="line"><span class="comment"> * the {<span class="doctag">@link</span> GenericApplicationListener} interface instead.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 3.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> GenericApplicationListener</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> GenericApplicationListenerAdapter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SmartApplicationListener</span> <span class="keyword">extends</span> <span class="title">ApplicationListener</span>&lt;<span class="title">ApplicationEvent</span>&gt;, <span class="title">Ordered</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * äº‹ä»¶ç±»å‹</span></span><br><span class="line"><span class="comment">	 * Determine whether this listener actually supports the given event type.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> eventType the event type (never {<span class="doctag">@code</span> null})</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">supportsEventType</span><span class="params">(Class&lt;? extends ApplicationEvent&gt; eventType)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * äº‹ä»¶æ¥æº</span></span><br><span class="line"><span class="comment">	 * Determine whether this listener actually supports the given source type.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;The default implementation always returns {<span class="doctag">@code</span> true}.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> sourceType the source type, or {<span class="doctag">@code</span> null} if no source</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">supportsSourceType</span><span class="params">(@Nullable Class&lt;?&gt; sourceType)</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Determine this listener's order in a set of listeners for the same event.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;The default implementation returns {<span class="doctag">@link</span> #LOWEST_PRECEDENCE}.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> LOWEST_PRECEDENCE;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-1-GenericApplicationListener"><a href="#2-1-GenericApplicationListener" class="headerlink" title="2.1 GenericApplicationListener"></a>2.1 GenericApplicationListener</h2><p><code>org.springframework.context.event.GenericApplicationListener</code> ï¼Œç»§æ‰¿ ApplicationListenerã€Ordered æ¥å£ï¼Œæ˜¯ Spring4.2 æ–°å¢çš„æ¥å£ï¼Œå®ƒå¢å¼ºäº†å¯¹æ³›å‹çš„æ”¯æŒï¼Œ<code>#supportsEventType(ResolvableType)</code> æ–¹æ³•çš„å‚æ•°é‡‡ç”¨çš„æ˜¯å¯è§£æç±»å‹ ResolvableType ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>ResolvableTypeæ˜¯ Spring4 æä¾›çš„æ³›å‹æ“ä½œæ”¯æŒç±»ï¼Œé€šè¿‡å®ƒå¯ä»¥å¾ˆå®¹æ˜“åœ°è·å¾—æ³›å‹çš„å®é™…ç±»å‹ä¿¡æ¯ï¼Œæ¯”å¦‚ç±»çº§ã€å­—æ®µçº§ç­‰ç­‰æ³›å‹ä¿¡æ¯ã€‚åœ¨ Spring4 çš„æ¡†æ¶ä¸­ï¼Œå¾ˆå¤šæ ¸å¿ƒç±»å†…éƒ¨æ¶‰åŠçš„æ³›å‹æ“ä½œå¤§éƒ½ä½¿ç”¨ ResolvableType ç±»è¿›è¡Œå¤„ç†ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// GenericApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Extended variant of the standard {<span class="doctag">@link</span> ApplicationListener} interface,</span></span><br><span class="line"><span class="comment"> * exposing further metadata such as the supported event and source type.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;As of Spring Framework 4.2, this interface supersedes the Class-based</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> SmartApplicationListener} with full handling of generic event types.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Stephane Nicoll</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 4.2</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> SmartApplicationListener</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> GenericApplicationListenerAdapter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GenericApplicationListener</span> <span class="keyword">extends</span> <span class="title">ApplicationListener</span>&lt;<span class="title">ApplicationEvent</span>&gt;, <span class="title">Ordered</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * äº‹ä»¶ç±»å‹ã€æœ‰å˜åŠ¨ã€‘</span></span><br><span class="line"><span class="comment">	 * Determine whether this listener actually supports the given event type.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> eventType the event type (never {<span class="doctag">@code</span> null})</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">supportsEventType</span><span class="params">(ResolvableType eventType)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * äº‹ä»¶æ¥æº</span></span><br><span class="line"><span class="comment">	 * Determine whether this listener actually supports the given source type.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;The default implementation always returns {<span class="doctag">@code</span> true}.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> sourceType the source type, or {<span class="doctag">@code</span> null} if no source</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">supportsSourceType</span><span class="params">(@Nullable Class&lt;?&gt; sourceType)</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Determine this listener's order in a set of listeners for the same event.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;The default implementation returns {<span class="doctag">@link</span> #LOWEST_PRECEDENCE}.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> LOWEST_PRECEDENCE;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="3-SpringApplication-ä¸­çš„ä½¿ç”¨"><a href="#3-SpringApplication-ä¸­çš„ä½¿ç”¨" class="headerlink" title="3. SpringApplication ä¸­çš„ä½¿ç”¨"></a>3. SpringApplication ä¸­çš„ä½¿ç”¨</h1><p>åœ¨ SpringApplication æ„é€ æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨ <code>#getSpringFactoriesInstances(Class&lt;T&gt; type)</code> æ–¹æ³•ï¼Œè·å¾— ApplicationListener é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// SpringApplication.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">Collection&lt;T&gt; <span class="title">getSpringFactoriesInstances</span><span class="params">(Class&lt;T&gt; type)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> getSpringFactoriesInstances(type, <span class="keyword">new</span> Class&lt;?&gt;[] {});</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">Collection&lt;T&gt; <span class="title">getSpringFactoriesInstances</span><span class="params">(Class&lt;T&gt; type,</span></span></span><br><span class="line"><span class="function"><span class="params">        Class&lt;?&gt;[] parameterTypes, Object... args)</span> </span>{</span><br><span class="line">    ClassLoader classLoader = getClassLoader();</span><br><span class="line">    <span class="comment">// Use names and ensure unique to protect against duplicates</span></span><br><span class="line">    <span class="comment">// &lt;1&gt; åŠ è½½æŒ‡å®šç±»å‹å¯¹åº”çš„ï¼Œåœ¨ `META-INF/spring.factories` é‡Œçš„ç±»åçš„æ•°ç»„</span></span><br><span class="line">    Set&lt;String&gt; names = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(SpringFactoriesLoader.loadFactoryNames(type, classLoader));</span><br><span class="line">    <span class="comment">// &lt;2&gt; åˆ›å»ºå¯¹è±¡ä»¬</span></span><br><span class="line">    List&lt;T&gt; instances = createSpringFactoriesInstances(type, parameterTypes, classLoader, args, names);</span><br><span class="line">    <span class="comment">// &lt;3&gt; æ’åºå¯¹è±¡ä»¬</span></span><br><span class="line">    AnnotationAwareOrderComparator.sort(instances);</span><br><span class="line">    <span class="keyword">return</span> instances;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼ŒåŠ è½½æŒ‡å®š ApplicationListener ç±»å‹å¯¹åº”çš„ï¼Œåœ¨ <code>META-INF/spring.factories</code> é‡Œçš„ç±»åçš„æ•°ç»„ã€‚<ul>
<li>å‡è®¾åªåœ¨ Spring MVC çš„ç¯å¢ƒä¸‹ï¼Œ<code>listeners</code> å±æ€§çš„ç»“æœå¦‚ä¸‹å›¾ï¼š<img src="http://static2.iocoder.cn/images/Spring-Boot/2021-01-07/02.jpg" alt="`listeners` å±æ€§"></li>
<li>è‰¿è‰¿æ•´ç†äº† Spring Boot ä¸­ï¼ŒApplicationContextInitializer çš„å®ç°ç±»ä»¬ï¼Œéå¸¸å¤šã€‚æœ¬æ–‡ï¼Œæˆ‘ä»¬å°±åˆ†äº«ä¸Šè¿°çš„ 10 ä¸ªã€‚</li>
</ul>
</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œåˆ›å»ºå¯¹è±¡ä»¬ã€‚</li>
<li><code>&lt;3&gt;</code> å¤„ï¼Œæ’åºå¯¹è±¡ä»¬ã€‚</li>
</ul>
<h1 id="4-ConfigFileApplicationListener"><a href="#4-ConfigFileApplicationListener" class="headerlink" title="4. ConfigFileApplicationListener"></a>4. ConfigFileApplicationListener</h1><p><code>org.springframework.boot.context.config.ConfigFileApplicationListener</code> ï¼Œå®ç° SmartApplicationListenerã€Orderedã€EnvironmentPostProcessor æ¥å£ï¼Œå®ç° Spring Boot é…ç½®æ–‡ä»¶çš„åŠ è½½ã€‚</p>
<p>è€ƒè™‘åˆ°å®ƒéå¸¸é‡è¦ï¼Œä¸”å¤æ‚ï¼Œæˆ‘ä»¬å•ç‹¬åœ¨ <a href="http://svip.iocoder.cn/Spring-Boot/properties-load">ã€Šç²¾å°½ Spring Boot æºç åˆ†æ â€”â€” é…ç½®åŠ è½½ã€‹</a> è¯¦ç»†è§£æã€‚</p>
<h1 id="5-AnsiOutputApplicationListener"><a href="#5-AnsiOutputApplicationListener" class="headerlink" title="5. AnsiOutputApplicationListener"></a>5. AnsiOutputApplicationListener</h1><p><code>org.springframework.boot.context.config.AnsiOutputApplicationListener</code> ï¼Œå®ç° ApplicationListenerã€Ordered æ¥å£ï¼Œåœ¨ Spring Boot ç¯å¢ƒå˜é‡(<code>environment</code>)å‡†å¤‡å®Œæˆä»¥åè¿è¡Œï¼Œ<br>å¦‚æœä½ çš„ç»ˆç«¯æ”¯æŒ ANSI ï¼Œè®¾ç½®å½©è‰²è¾“å‡ºä¼šè®©æ—¥å¿—æ›´å…·å¯è¯»æ€§ã€‚</p>
<blockquote>
<p>ä¸äº†è§£â€œå½©è‰²è¾“å‡ºâ€çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ <a href="http://blog.didispace.com/springbootlog/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Bootæ—¥å¿—ç®¡ç†ã€‹</a> æ–‡ç« ã€‚</p>
</blockquote>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigFileApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnsiOutputApplicationListener</span></span></span><br><span class="line"><span class="class">		<span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">ApplicationEnvironmentPreparedEvent</span>&gt;, <span class="title">Ordered</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ApplicationEnvironmentPreparedEvent event)</span> </span>{ <span class="comment">// &lt;1&gt;</span></span><br><span class="line"><span class="comment">//	    if (true) { </span></span><br><span class="line"><span class="comment">//	        return; // &lt;X&gt;</span></span><br><span class="line"><span class="comment">//        }</span></span><br><span class="line">		ConfigurableEnvironment environment = event.getEnvironment();</span><br><span class="line">		<span class="comment">// &lt;2&gt; æ ¹æ®ç¯å¢ƒå˜é‡ spring.output.ansi.enabled çš„å€¼ï¼Œè®¾ç½® AnsiOutput.enabled å±æ€§</span></span><br><span class="line">		Binder.get(environment).bind(<span class="string">"spring.output.ansi.enabled"</span>, AnsiOutput.Enabled.class)</span><br><span class="line">                .ifBound(AnsiOutput::setEnabled);</span><br><span class="line">		<span class="comment">// &lt;3&gt; æ ¹æ®ç¯å¢ƒå˜é‡ "spring.output.ansi.console-available çš„å€¼ï¼Œè®¾ç½® AnsiOutput.consoleAvailable å±æ€§</span></span><br><span class="line">		AnsiOutput.setConsoleAvailable(environment.getProperty(<span class="string">"spring.output.ansi.console-available"</span>, Boolean.class));</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="comment">// Apply after ConfigFileApplicationListener has called EnvironmentPostProcessors</span></span><br><span class="line">		<span class="keyword">return</span> ConfigFileApplicationListener.DEFAULT_ORDER + <span class="number">1</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œç›‘å¬çš„æ˜¯ ApplicationEnvironmentPreparedEvent äº‹ä»¶ã€‚</li>
<li><p><code>&lt;2&gt;</code> å¤„ï¼Œæ ¹æ®ç¯å¢ƒå˜é‡ <code>"spring.output.ansi.enabled"</code> çš„å€¼ï¼Œè®¾ç½® <code>AnsiOutput.enabled</code> å±æ€§ã€‚è¿™å—çš„é€»è¾‘ï¼Œå¡äº†è‰¿è‰¿å¾ˆä¹…ï¼Œä¸€ç‚¹ä¸€ç‚¹æ¥è¯´ã€‚</p>
<ul>
<li><p>é¦–å…ˆï¼Œå› ä¸ºè‰¿è‰¿å¹¶æ²¡æœ‰ç»†çœ‹ Binder çš„å®ç°ä»£ç ï¼Œæ‰€ä»¥è¿™å—å°±å¡äº†ä¸€ä¼šã€‚ç®€å•æ¥è¯´ï¼Œ<code>Binder.get(environment).bind("spring.output.ansi.enabled", AnsiOutput.Enabled.class)</code> ä»£ç å—çš„æ„æ€æ˜¯ï¼Œä» <code>environment</code> è¯»å– <code>"spring.output.ansi.enabled"</code> å¯¹åº”çš„å€¼ï¼Œå¹¶è½¬æ¢æˆ AnsiOutput.Enabled ç±»å‹ã€‚å…¶ä¸­ï¼ŒAnsiOutput.Enabled çš„æšä¸¾å€¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AnsiOutput#Enabled.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Enabled {</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è‡ªåŠ¨æ¢æµ‹ï¼Œæ ¹æ®æ˜¯å¦æ”¯æŒ ANSI çš„åŠŸèƒ½ï¼Œæ¥åˆ¤æ–­æ˜¯å¦è¦å½©è‰²è¾“å‡º</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * ã€é»˜è®¤å€¼ã€‘</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">	 * Try to detect whether ANSI coloring capabilities are available. The default</span></span><br><span class="line"><span class="comment">	 * value for {<span class="doctag">@link</span> AnsiOutput}.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	DETECT,</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ€»æ˜¯å¼€å¯ ANSI å½©è‰²è¾“å‡º</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">	 * Enable ANSI-colored output.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ALWAYS,</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç¦ç”¨ ANSI å½©è‰²è¾“å‡º</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">	 * Disable ANSI-colored output.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	NEVER</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>è²Œä¼¼ä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜ã€‚ä½†æ˜¯ï¼Œè®©è‰¿è‰¿é—·é€¼çš„æ˜¯ï¼Œä¸ºä»€ä¹ˆç»“æœä¼šæ˜¯ <code>AnsiOutput.Enabled.ALWAYS</code> ï¼Œåœ¨ IDEA ç¯å¢ƒä¸­ã€‚åæ¥ï¼Œåœ¨ <code>environment</code> ä¸­ï¼Œä¸€ä¸ªåå­—æ˜¯ <code>"systemProperties"</code> çš„ MapPropertySource å±æ€§æºï¼Œé‡Œé¢æä¾›äº† <code>"spring.output.ansi.enabled=always"</code> çš„é…ç½®ã€‚</p>
<ul>
<li>å„ç§å…¨æ–‡æ£€ç´¢ä»£ç ï¼Œè²Œä¼¼é™¤äº†æµ‹è¯•ç”¨ä¾‹é‡Œï¼Œæ²¡æœ‰åœ°æ–¹å¼ºåˆ¶èµ‹å€¼äº† <code>"spring.output.ansi.enabled"</code> ã€‚</li>
<li>åæ¥å‘ç°ï¼Œ<code>"systemProperties"</code> è¿™ä¸ª MapPropertySource å±æ€§æºï¼Œè¯»å–çš„æ˜¯ <code>System#getProperties()</code> æ–¹æ³•ï¼Œä½†æ˜¯ä¸ºå•¥é‡Œé¢ä¼šæœ‰ <code>"spring.output.ansi.enabled=always"</code> å‘¢ï¼Ÿç›®å‰çš„çŒœæµ‹æ˜¯ï¼ŒIDEA åˆ¤æ–­åœ¨ Spring Boot ç¯å¢ƒä¸‹ï¼Œè‡ªåŠ¨æ·»åŠ è¿›å»çš„ï¼<ul>
<li>ç„¶åï¼Œ<code>.ifBound(AnsiOutput::setEnabled)</code> ä»£ç æ®µï¼Œåº”è¯¥ç¿»è¯‘æˆå¦‚ä¸‹çš„ä»£ç ï¼Œå¯èƒ½æ¯”è¾ƒæ˜“æ‡‚ï¼š<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">Binder.get(environment).bind(<span class="string">"spring.output.ansi.enabled"</span>, AnsiOutput.Enabled.class)</span><br><span class="line">.ifBound(<span class="keyword">new</span> Consumer&lt;Enabled&gt;() {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Enabled enabled)</span> </span>{</span><br><span class="line">        AnsiOutput.setEnabled(enabled);</span><br><span class="line">    }</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>å³ï¼Œ<code>Binder.get(environment).bind("spring.output.ansi.enabled", AnsiOutput.Enabled.class)</code> è¿”å›çš„æ˜¯ BindResult å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ <code>BindResult#ifBound(Consumer)</code> æ–¹æ³•ï¼Œå°†è§£æåˆ°çš„å±æ€§å€¼ï¼Œèµ‹å€¼åˆ° <code>AnsiOutput.enabled</code> å±æ€§ã€‚</p>
<ul>
<li>ğŸ˜ˆ çœŸçš„æ˜¯æœ‰ç‚¹ç»•å™¢ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p><code>&lt;3&gt;</code> å¤„ï¼Œæ ¹æ®ç¯å¢ƒå˜é‡ <code>"spring.output.ansi.console-available"</code> çš„å€¼ï¼Œè®¾ç½® <code>AnsiOutput.consoleAvailable</code> å±æ€§ã€‚</p>
</li>
</ul>
<p>é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œåç»­åœ¨ IDEA ä¸­ï¼Œæˆ‘ä»¬å°±å¯ä»¥å‘ç°æ—¥å¿—æ‰“å°å‡ºæ¥çš„ï¼Œæ˜¯å¸¦æœ‰å½©è‰²è¾“å‡ºçš„ã€‚å¦‚æœèƒ–å‹æ˜¯ä¸ªè°ƒçš®çš„äººï¼Œå¯ä»¥å°è¯•æ‰“å¼€ <code>&lt;X&gt;</code> å¤„çš„ä¸‰è¡Œæ³¨é‡Šï¼Œç„¶åé‡æ–°è¿è¡Œï¼Œå°±ç¥å¥‡çš„å‘ç°ï¼Œå½©è‰²è¾“å‡ºä¸è§äº†ï¼Œå˜¿å˜¿å˜¿ã€‚</p>
<h1 id="6-LoggingApplicationListener"><a href="#6-LoggingApplicationListener" class="headerlink" title="6. LoggingApplicationListener"></a>6. LoggingApplicationListener</h1><p><code>org.springframework.boot.context.logging.LoggingApplicationListener</code> ï¼Œå®ç° GenericApplicationListener æ¥å£ï¼Œå®ç°æ ¹æ®é…ç½®åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ Logger ã€‚</p>
<p>è€ƒè™‘åˆ°å®ƒéå¸¸é‡è¦ï¼Œä¸”å¤æ‚ï¼Œæˆ‘ä»¬å•ç‹¬åœ¨ <a href="http://svip.iocoder.cn/Spring-Boot/logger-system">ã€Šç²¾å°½ Spring Boot æºç åˆ†æ â€”â€” æ—¥å¿—ç³»ç»Ÿã€‹</a> è¯¦ç»†è§£æã€‚</p>
<h1 id="7-ClasspathLoggingApplicationListener"><a href="#7-ClasspathLoggingApplicationListener" class="headerlink" title="7. ClasspathLoggingApplicationListener"></a>7. ClasspathLoggingApplicationListener</h1><p><code>org.springframework.boot.context.logging.ClasspathLoggingApplicationListener</code> ï¼Œå®ç° GenericApplicationListener æ¥å£ï¼Œç¨‹åºå¯åŠ¨æ—¶ï¼Œå°† classpath æ‰“å°åˆ° debug æ—¥å¿—ï¼Œå¯åŠ¨å¤±è´¥æ—¶ classpath æ‰“å°åˆ° debug æ—¥å¿—ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ClasspathLoggingApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ClasspathLoggingApplicationListener</span> <span class="keyword">implements</span> <span class="title">GenericApplicationListener</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é¡ºåº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ORDER = LoggingApplicationListener.DEFAULT_ORDER + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(ClasspathLoggingApplicationListener.class);</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ApplicationEvent event)</span> </span>{</span><br><span class="line">		<span class="keyword">if</span> (logger.isDebugEnabled()) {</span><br><span class="line">		    <span class="comment">// å¦‚æœæ˜¯ ApplicationEnvironmentPreparedEvent äº‹ä»¶ï¼Œè¯´æ˜å¯åŠ¨æˆåŠŸï¼Œæ‰“å°æˆåŠŸåˆ° debug æ—¥å¿—ä¸­</span></span><br><span class="line">			<span class="keyword">if</span> (event <span class="keyword">instanceof</span> ApplicationEnvironmentPreparedEvent) {</span><br><span class="line">				logger.debug(<span class="string">"Application started with classpath: "</span> + getClasspath());</span><br><span class="line">            <span class="comment">// å¦‚æœæ˜¯ ApplicationFailedEvent äº‹ä»¶ï¼Œè¯´æ˜å¯åŠ¨å¤±è´¥ï¼Œæ‰“å°å¤±è´¥åˆ° debug æ—¥å¿—ä¸­</span></span><br><span class="line">			} <span class="keyword">else</span> <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ApplicationFailedEvent) {</span><br><span class="line">				logger.debug(<span class="string">"Application failed to start with classpath: "</span> + getClasspath());</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> ORDER;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsEventType</span><span class="params">(ResolvableType resolvableType)</span> </span>{</span><br><span class="line">		Class&lt;?&gt; type = resolvableType.getRawClass(); <span class="comment">// ä½¿ç”¨ ResolvableType ç±»ï¼Œå¯ä»¥è§£æå½“å‰ä¼ å…¥çš„å‚æ•°çš„æ³›å‹ï¼Œä»è€Œåçš„äº‹ä»¶ç±»å‹</span></span><br><span class="line">		<span class="keyword">if</span> (type == <span class="keyword">null</span>) {</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€ä¸º ApplicationEnvironmentPreparedEvent æˆ–è€… ApplicationFailedEvent äº‹ä»¶</span></span><br><span class="line">		<span class="keyword">return</span> ApplicationEnvironmentPreparedEvent.class.isAssignableFrom(type)</span><br><span class="line">				|| ApplicationFailedEvent.class.isAssignableFrom(type);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è·å¾— classpath</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> String <span class="title">getClasspath</span><span class="params">()</span> </span>{</span><br><span class="line">		ClassLoader classLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">		<span class="keyword">if</span> (classLoader <span class="keyword">instanceof</span> URLClassLoader) {</span><br><span class="line">			<span class="keyword">return</span> Arrays.toString(((URLClassLoader) classLoader).getURLs());</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"unknown"</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="8-BackgroundPreinitializer"><a href="#8-BackgroundPreinitializer" class="headerlink" title="8. BackgroundPreinitializer"></a>8. BackgroundPreinitializer</h1><p><code>org.springframework.boot.autoconfigure.BackgroundPreinitializer</code> ï¼Œå®ç° ApplicationListener æ¥å£ï¼Œå®ç°åå°æå‰æ‰§è¡Œè€—æ—¶çš„åˆå§‹åŒ–ä»»åŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// BackgroundPreinitializer.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Order</span>(LoggingApplicationListener.DEFAULT_ORDER + <span class="number">1</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BackgroundPreinitializer</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">SpringApplicationEvent</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * System property that instructs Spring Boot how to run pre initialization. When the</span></span><br><span class="line"><span class="comment">     * property is set to {<span class="doctag">@code</span> true}, no pre-initialization happens and each item is</span></span><br><span class="line"><span class="comment">     * initialized in the foreground as it needs to. When the property is {<span class="doctag">@code</span> false}</span></span><br><span class="line"><span class="comment">     * (default), pre initialization runs in a separate thread in the background.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 2.1.0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String IGNORE_BACKGROUNDPREINITIALIZER_PROPERTY_NAME = <span class="string">"spring.backgroundpreinitializer.ignore"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é¢„åˆå§‹åŒ–ä»»åŠ¡æ˜¯å¦å·²å¯åŠ¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicBoolean preinitializationStarted = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é¢„åˆå§‹åŒ–ä»»åŠ¡çš„ CountDownLatch å¯¹è±¡ï¼Œç”¨äºå®ç°ç­‰å¾…é¢„åˆå§‹åŒ–ä»»åŠ¡æ˜¯å¦å®Œæˆ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> CountDownLatch preinitializationComplete = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(SpringApplicationEvent event)</span> </span>{</span><br><span class="line">        <span class="comment">// &lt;1&gt; å¦‚æœæ˜¯å¼€å¯åå°é¢„åˆå§‹åŒ–ä»»åŠ¡ï¼Œé»˜è®¤æƒ…å†µä¸‹å¼€å¯</span></span><br><span class="line">        <span class="comment">// å¹¶ä¸”ï¼Œæ˜¯ ApplicationStartingEvent äº‹ä»¶ï¼Œè¯´æ˜åº”ç”¨æ­£åœ¨å¯åŠ¨ä¸­</span></span><br><span class="line">        <span class="comment">// å¹¶ä¸”ï¼Œæ˜¯å¤šæ ¸ç¯å¢ƒ</span></span><br><span class="line">        <span class="comment">// å¹¶ä¸”ï¼Œé¢„åˆå§‹åŒ–ä»»åŠ¡æœªå¯åŠ¨</span></span><br><span class="line">        <span class="keyword">if</span> (!Boolean.getBoolean(IGNORE_BACKGROUNDPREINITIALIZER_PROPERTY_NAME)</span><br><span class="line">                &amp;&amp; event <span class="keyword">instanceof</span> ApplicationStartingEvent</span><br><span class="line">                &amp;&amp; multipleProcessors()</span><br><span class="line">                &amp;&amp; preinitializationStarted.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) {</span><br><span class="line">            <span class="comment">// å¯åŠ¨</span></span><br><span class="line">            performPreinitialization();</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// &lt;2&gt; å¦‚æœæ˜¯ ApplicationReadyEvent æˆ– ApplicationFailedEvent äº‹ä»¶ï¼Œè¯´æ˜åº”ç”¨å¯åŠ¨æˆåŠŸåå¤±è´¥ï¼Œåˆ™ç­‰å¾…é¢„åˆå§‹åŒ–ä»»åŠ¡å®Œæˆ</span></span><br><span class="line">        <span class="keyword">if</span> ((event <span class="keyword">instanceof</span> ApplicationReadyEvent</span><br><span class="line">                || event <span class="keyword">instanceof</span> ApplicationFailedEvent)</span><br><span class="line">                &amp;&amp; preinitializationStarted.get()) { <span class="comment">// åˆ¤æ–­é¢„åˆå§‹åŒ–ä»»åŠ¡å·²ç»å¯åŠ¨</span></span><br><span class="line">            <span class="comment">// é€šè¿‡ CountDownLatch å®ç°ï¼Œé¢„åˆå§‹åŒ–ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚</span></span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                preinitializationComplete.await();</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException ex) {</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> åˆ¤æ–­æ˜¯å¦å¤šæ ¸ç¯å¢ƒ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">multipleProcessors</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> Runtime.getRuntime().availableProcessors() &gt; <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å‡ ä¸ªå˜é‡ï¼Œèƒ–å‹ç›´æ¥çœ‹ä»£ç æ³¨é‡Šã€‚</li>
<li><code>&lt;1&gt;</code> å¤„ï¼Œæ»¡è¶³å¦‚ä¸‹çš„å››ä¸ªæ¡ä»¶ï¼ˆæ¯ä¸€è¡Œæ³¨é‡Šï¼Œå¯¹åº”ä¸€ä¸ªæ¡ä»¶ï¼‰ï¼Œè°ƒç”¨ <code>#performPreinitialization()</code> æ–¹æ³•ï¼Œå¯åŠ¨çº¿ç¨‹ï¼Œåå°æ‰§è¡Œé¢„åˆå§‹åŒ–ä»»åŠ¡ã€‚å…³äº <code>#performPreinitialization()</code> æ–¹æ³•ï¼Œåœ¨ <a href="#">ã€Œ8.1 performPreinitializationã€</a> è¯¦ç»†è§£æã€‚</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œå¦‚æœæ˜¯ ApplicationReadyEvent æˆ– ApplicationFailedEvent äº‹ä»¶ï¼Œè¯´æ˜åº”ç”¨å¯åŠ¨æˆåŠŸåå¤±è´¥ï¼Œåˆ™ç­‰å¾…é¢„åˆå§‹åŒ–ä»»åŠ¡å®Œæˆã€‚</li>
<li>æ€»ç»“æ¥è¯´ï¼Œ<code>&lt;1&gt;</code> å¤„ï¼Œå¯åŠ¨åå°ä»»åŠ¡ï¼Œ<code>&lt;2&gt;</code> å¤„ï¼Œä¿è¯åå°ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚</li>
</ul>
<h2 id="8-1-performPreinitialization"><a href="#8-1-performPreinitialization" class="headerlink" title="8.1 performPreinitialization"></a>8.1 performPreinitialization</h2><p><code>#performPreinitialization()</code> æ–¹æ³•ï¼Œå¯åŠ¨çº¿ç¨‹ï¼Œåå°æ‰§è¡Œé¢„åˆå§‹åŒ–ä»»åŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// BackgroundPreinitializer.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performPreinitialization</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// &lt;1&gt; åˆ›å»ºçº¿ç¨‹</span></span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() {</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">                <span class="comment">// å®‰å…¨è¿è¡Œæ¯ä¸ªåˆå§‹åŒ–ä»»åŠ¡</span></span><br><span class="line">                runSafely(<span class="keyword">new</span> ConversionServiceInitializer());</span><br><span class="line">                runSafely(<span class="keyword">new</span> ValidationInitializer());</span><br><span class="line">                runSafely(<span class="keyword">new</span> MessageConverterInitializer());</span><br><span class="line">                runSafely(<span class="keyword">new</span> MBeanFactoryInitializer());</span><br><span class="line">                runSafely(<span class="keyword">new</span> JacksonInitializer());</span><br><span class="line">                runSafely(<span class="keyword">new</span> CharsetInitializer());</span><br><span class="line">                <span class="comment">// &lt;3&gt; æ ‡è®° preinitializationComplete å®Œæˆ</span></span><br><span class="line">                preinitializationComplete.countDown();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runSafely</span><span class="params">(Runnable runnable)</span> </span>{</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    runnable.run();</span><br><span class="line">                } <span class="keyword">catch</span> (Throwable ex) {</span><br><span class="line">                    <span class="comment">// Ignore</span></span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">        }, <span class="string">"background-preinit"</span>);</span><br><span class="line">        <span class="comment">// &lt;2&gt; å¯åŠ¨çº¿ç¨‹</span></span><br><span class="line">        thread.start();</span><br><span class="line">    } <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line">        <span class="comment">// This will fail on GAE where creating threads is prohibited. We can safely</span></span><br><span class="line">        <span class="comment">// continue but startup will be slightly slower as the initialization will now</span></span><br><span class="line">        <span class="comment">// happen on the main thread.</span></span><br><span class="line">        <span class="comment">// æ ‡è®° preinitializationComplete å®Œæˆ</span></span><br><span class="line">        preinitializationComplete.countDown();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œç”¨äºåå°è°ƒç”¨ <code>#runSafely(Runnable runnable)</code> æ–¹æ³•ï¼Œâ€œå®‰å…¨â€ï¼ˆå³å‘ç”Ÿå¼‚å¸¸ï¼Œä¸è¿›è¡ŒæŠ›å‡ºå»ï¼‰æ‰§è¡Œæ¯ä¸ªåˆå§‹åŒ–ä»»åŠ¡ã€‚</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œå¯åŠ¨çº¿ç¨‹ã€‚</li>
<li><code>&lt;3&gt;</code> å¤„ï¼Œåœ¨æ‰€æœ‰åˆå§‹åŒ–ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆåï¼Œé€šè¿‡æ ‡è®° <code>preinitializationComplete</code> å®Œæˆï¼Œä»è€Œå®ç°åœ¨ <code>#onApplicationEvent(SpringApplicationEvent even)</code> çš„ <code>&lt;2&gt;</code> å¤„çš„é˜»å¡ç­‰å¾…è¢«é€šçŸ¥å®Œæˆã€‚</li>
</ul>
<h2 id="8-2-åˆå§‹åŒ–ä»»åŠ¡"><a href="#8-2-åˆå§‹åŒ–ä»»åŠ¡" class="headerlink" title="8.2 åˆå§‹åŒ–ä»»åŠ¡"></a>8.2 åˆå§‹åŒ–ä»»åŠ¡</h2><ul>
<li><a href="https://github.com/YunaiV/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/BackgroundPreinitializer.java#L180" rel="external nofollow noopener noreferrer" target="_blank">ConversionServiceInitializer</a></li>
<li><a href="https://github.com/YunaiV/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/BackgroundPreinitializer.java#L155" rel="external nofollow noopener noreferrer" target="_blank">ValidationInitializer</a></li>
<li><a href="https://github.com/YunaiV/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/BackgroundPreinitializer.java#L131" rel="external nofollow noopener noreferrer" target="_blank">MessageConverterInitializer</a></li>
<li><a href="https://github.com/YunaiV/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/BackgroundPreinitializer.java#L143" rel="external nofollow noopener noreferrer" target="_blank">MBeanFactoryInitializer</a></li>
<li><a href="https://github.com/YunaiV/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/BackgroundPreinitializer.java#L168" rel="external nofollow noopener noreferrer" target="_blank">JacksonInitializer</a></li>
<li><a href="https://github.com/YunaiV/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/BackgroundPreinitializer.java#L189" rel="external nofollow noopener noreferrer" target="_blank">CharsetInitializer</a></li>
</ul>
<h1 id="9-DelegatingApplicationListener"><a href="#9-DelegatingApplicationListener" class="headerlink" title="9. DelegatingApplicationListener"></a>9. DelegatingApplicationListener</h1><p><code>org.springframework.boot.context.config.DelegatingApplicationListener</code> ï¼Œå®ç° ApplicationListenerã€Ordered æ¥å£ï¼Œå’Œ <a href="http://svip.iocoder.cn/Spring-Boot/ApplicationContextInitializer">ã€ŒDelegatingApplicationContextInitializerã€</a> æ˜¯ç±»ä¼¼çš„ï¼Œåªæ˜¯è¯»å–çš„æ˜¯ç¯å¢ƒå˜é‡ <code>"context.listener.classes"</code> å¯¹åº”çš„ ApplicationContextInitializer å®ç°ç±»ä»¬ã€‚</p>
<h1 id="10-ParentContextCloserApplicationListener"><a href="#10-ParentContextCloserApplicationListener" class="headerlink" title="10. ParentContextCloserApplicationListener"></a>10. ParentContextCloserApplicationListener</h1><p><code>org.springframework.boot.builder.ParentContextCloserApplicationListener</code> ï¼Œå®ç° ApplicationListenerã€ApplicationContextAwareã€Ordered æ¥å£ï¼Œå®¹å™¨å…³é—­æ—¶å‘å‡ºé€šçŸ¥ï¼Œå¦‚æœçˆ¶å®¹å™¨å…³é—­ï¼Œé‚£ä¹ˆè‡ªå®¹å™¨ä¹Ÿä¸€èµ·å…³é—­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ParentContextCloserApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParentContextCloserApplicationListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">ParentContextAvailableEvent</span>&gt;, <span class="title">ApplicationContextAware</span>, <span class="title">Ordered</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é¡ºåº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> order = Ordered.LOWEST_PRECEDENCE - <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ApplicationContext context;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.order;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext context)</span> <span class="keyword">throws</span> BeansException </span>{</span><br><span class="line">		<span class="keyword">this</span>.context = context;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ParentContextAvailableEvent event)</span> </span>{</span><br><span class="line">		maybeInstallListenerInParent(event.getApplicationContext()); <span class="comment">// &lt;1&gt;</span></span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// ... çœç•¥å…¶å®ƒæ–¹æ³•</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨ <code>&lt;1&gt;</code> å¤„ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å½“æ¥æ”¶åˆ° ParentContextAvailableEvent äº‹ä»¶åï¼Œä¼šè°ƒç”¨ <code>#maybeInstallListenerInParent(ConfigurableApplicationContext child)</code> æ–¹æ³•ï¼Œå‘çˆ¶å®¹å™¨æ·»åŠ ç›‘å¬å™¨ï¼Œç›‘å¬çˆ¶å®¹å™¨çš„å…³é—­äº‹ä»¶ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ10.1 maybeInstallListenerInParentã€</a> ã€‚</li>
<li>ParentContextAvailableEvent äº‹ä»¶çš„å‘å¸ƒï¼Œä¾èµ– <a href="https://github.com/YunaiV/spring-boot/blob/master/spring-boot-project/spring-boot/src/main/java/org/springframework/boot/builder/ParentContextApplicationContextInitializer.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.springframework.boot.builder.ParentContextApplicationContextInitializer</code></a> åˆå§‹åŒ–ç±»ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒParentContextApplicationContextInitializer ç±»å¹¶æœªä½¿ç”¨ï¼Œæ‰€ä»¥å§ï¼ŒğŸ˜ˆ ParentContextCloserApplicationListener åŸºæœ¬æ— æ³•ç”Ÿæ•ˆåˆ—ã€‚</li>
</ul>
<h2 id="10-1-maybeInstallListenerInParent"><a href="#10-1-maybeInstallListenerInParent" class="headerlink" title="10.1 maybeInstallListenerInParent"></a>10.1 maybeInstallListenerInParent</h2><p><code>#maybeInstallListenerInParent(ConfigurableApplicationContext child)</code> æ–¹æ³•ï¼Œå‘çˆ¶å®¹å™¨æ·»åŠ ç›‘å¬å™¨ï¼Œç›‘å¬çˆ¶å®¹å™¨çš„å…³é—­äº‹ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ParentContextCloserApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeInstallListenerInParent</span><span class="params">(ConfigurableApplicationContext child)</span> </span>{</span><br><span class="line">    <span class="comment">// å¦‚æœ child æ˜¯å½“å‰å®¹å™¨</span></span><br><span class="line">    <span class="keyword">if</span> (child == <span class="keyword">this</span>.context</span><br><span class="line">            <span class="comment">// å¹¶ä¸”çˆ¶å®¹å™¨æ˜¯ ConfigurableApplicationContext ç±»å‹</span></span><br><span class="line">            &amp;&amp; child.getParent() <span class="keyword">instanceof</span> ConfigurableApplicationContext) {</span><br><span class="line">        <span class="comment">// å‘çˆ¶å®¹å™¨æ·»åŠ ç›‘å¬å™¨ï¼Œç›‘å¬çˆ¶å®¹å™¨çš„å…³é—­äº‹ä»¶</span></span><br><span class="line">        ConfigurableApplicationContext parent = (ConfigurableApplicationContext) child.getParent();</span><br><span class="line">        parent.addApplicationListener(createContextCloserListener(child)); <span class="comment">// &lt;1&gt;</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>åœ¨ <code>&lt;1&gt;</code> å¤„ï¼Œä¼šè°ƒç”¨ <code>#createContextCloserListener(ConfigurableApplicationContext child)</code> æ–¹æ³•ï¼Œåˆ›å»º ContextCloserListener å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ParentContextCloserApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> ContextCloserListener <span class="title">createContextCloserListener</span><span class="params">(ConfigurableApplicationContext child)</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> ContextCloserListener(child);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å…³äº ContextCloserListener ç±»ï¼Œåœ¨ <a href="#">ã€Œ10.2 ContextCloserListenerã€</a> ä¸­ï¼Œè¯¦ç»†è§£æã€‚</li>
</ul>
</li>
<li><code>&lt;1&gt;</code> å¤„ï¼Œåˆ›å»ºåçš„ ContextCloserListener å¯¹è±¡ï¼Œå‘çˆ¶å®¹å™¨ <code>parent</code> ä¸­æ³¨å†Œã€‚</li>
</ul>
<h2 id="10-2-ContextCloserListener"><a href="#10-2-ContextCloserListener" class="headerlink" title="10.2 ContextCloserListener"></a>10.2 ContextCloserListener</h2><p>ContextCloserListener ï¼Œæ˜¯ ParentContextCloserApplicationListener çš„å†…éƒ¨ç±»ï¼Œå®ç° ApplicationListener æ¥å£ï¼Œç›‘å¬çˆ¶å®¹å™¨å…³é—­æ—¶ï¼Œå…³é—­è‡ªå·±ï¼ˆå®¹å™¨ï¼‰ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ParentContextCloserApplicationListener#ContextCloserListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextCloserListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">ContextClosedEvent</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> WeakReference&lt;ConfigurableApplicationContext&gt; childContext;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ContextCloserListener</span><span class="params">(ConfigurableApplicationContext childContext)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.childContext = <span class="keyword">new</span> WeakReference&lt;&gt;(childContext);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ContextClosedEvent event)</span> </span>{</span><br><span class="line">        ConfigurableApplicationContext context = <span class="keyword">this</span>.childContext.get();</span><br><span class="line">        <span class="keyword">if</span> ((context != <span class="keyword">null</span>)</span><br><span class="line">                &amp;&amp; (event.getApplicationContext() == context.getParent()) <span class="comment">// å¦‚æœæ˜¯çˆ¶å®¹å™¨</span></span><br><span class="line">                &amp;&amp; context.isActive()) { <span class="comment">// å¹¶ä¸”å½“å‰å®¹å™¨æ˜¯å¯åŠ¨çŠ¶æ€</span></span><br><span class="line">            <span class="comment">// å…³é—­å½“å‰å®¹å™¨</span></span><br><span class="line">            context.close();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="11-ClearCachesApplicationListener"><a href="#11-ClearCachesApplicationListener" class="headerlink" title="11. ClearCachesApplicationListener"></a>11. ClearCachesApplicationListener</h1><p><code>org.springframework.boot.ClearCachesApplicationListener</code> ï¼Œå®ç° ApplicationListener æ¥å£ï¼Œå®ç° ReflectionUtils çš„ç¼“å­˜ã€ClassLoader çš„ç¼“å­˜ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ClearCachesApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClearCachesApplicationListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">ContextRefreshedEvent</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ContextRefreshedEvent event)</span> </span>{</span><br><span class="line">        <span class="comment">// æ¸…ç©º ReflectionUtils ç¼“å­˜</span></span><br><span class="line">        ReflectionUtils.clearCache();</span><br><span class="line">        <span class="comment">// æ¸…ç©ºç±»åŠ è½½å™¨çš„ç¼“å­˜</span></span><br><span class="line">        clearClassLoaderCaches(Thread.currentThread().getContextClassLoader());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearClassLoaderCaches</span><span class="params">(ClassLoader classLoader)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (classLoader == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// åŒæ„åå°„è°ƒç”¨ ClassLoader ç±»çš„ clearCache æ–¹æ³•ï¼Œæ¸…ç©ºå®ƒçš„ç¼“å­˜</span></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            Method clearCacheMethod = classLoader.getClass().getDeclaredMethod(<span class="string">"clearCache"</span>);</span><br><span class="line">            clearCacheMethod.invoke(classLoader);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line">            <span class="comment">// Ignore</span></span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// å¦‚æœæœ‰çˆ¶åŠ è½½å™¨ï¼Œåˆ™çˆ¶åŠ è½½å™¨æ¸…ç©ºç¼“å­˜</span></span><br><span class="line">        clearClassLoaderCaches(classLoader.getParent());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨æ¥æ”¶åˆ°å®¹å™¨åˆå§‹åŒ– ContextRefreshedEvent äº‹ä»¶ï¼Œè§¦å‘ ClearCachesApplicationListener ç›‘å¬å™¨ï¼Œè¿›è¡Œæ¸…ç©ºç¼“å­˜ã€‚</li>
</ul>
<h1 id="12-FileEncodingApplicationListener"><a href="#12-FileEncodingApplicationListener" class="headerlink" title="12. FileEncodingApplicationListener"></a>12. FileEncodingApplicationListener</h1><p><code>org.springframework.boot.context.FileEncodingApplicationListener</code> ï¼Œå®ç° ApplicationListenerã€Ordered æ¥å£ï¼Œåœ¨Spring Boot ç¯å¢ƒå‡†å¤‡å®Œæˆä»¥åè¿è¡Œï¼Œè·å–ç¯å¢ƒä¸­çš„ç³»ç»Ÿç¯å¢ƒå‚æ•°ï¼Œæ£€æµ‹å½“å‰ç³»ç»Ÿç¯å¢ƒçš„ <code>file.encoding</code> å’Œ <code>spring.mandatory-file-encoding</code> è®¾ç½®çš„å€¼æ˜¯å¦ä¸€æ ·ï¼Œå¦‚æœä¸ä¸€æ ·åˆ™æŠ›å‡ºå¼‚å¸¸ï¼›<br>å¦‚æœä¸é…ç½® <code>spring.mandatory-file-encoding</code> åˆ™ä¸æ£€æŸ¥ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// FileEncodingApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileEncodingApplicationListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">ApplicationEnvironmentPreparedEvent</span>&gt;, <span class="title">Ordered</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(FileEncodingApplicationListener.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> Ordered.LOWEST_PRECEDENCE;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ApplicationEnvironmentPreparedEvent event)</span> </span>{</span><br><span class="line">        ConfigurableEnvironment environment = event.getEnvironment();</span><br><span class="line">        <span class="comment">// å¦‚æœæœªé…ç½®ï¼Œåˆ™ä¸è¿›è¡Œæ£€æŸ¥</span></span><br><span class="line">        <span class="keyword">if</span> (!environment.containsProperty(<span class="string">"spring.mandatory-file-encoding"</span>)) {</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// æ¯”å¯¹ç³»ç»Ÿå˜é‡çš„ `file.encoding` ï¼Œå’Œç¯å¢ƒå˜é‡çš„ `spring.mandatory-file-encoding` ã€‚</span></span><br><span class="line">        <span class="comment">// å¦‚æœä¸ä¸€è‡´ï¼ŒæŠ›å‡º IllegalStateException å¼‚å¸¸</span></span><br><span class="line">        String encoding = System.getProperty(<span class="string">"file.encoding"</span>);</span><br><span class="line">        String desired = environment.getProperty(<span class="string">"spring.mandatory-file-encoding"</span>);</span><br><span class="line">        <span class="keyword">if</span> (encoding != <span class="keyword">null</span> &amp;&amp; !desired.equalsIgnoreCase(encoding)) {</span><br><span class="line">            logger.error(<span class="string">"System property 'file.encoding' is currently '"</span> + encoding</span><br><span class="line">                    + <span class="string">"'. It should be '"</span> + desired</span><br><span class="line">                    + <span class="string">"' (as defined in 'spring.mandatoryFileEncoding')."</span>);</span><br><span class="line">            logger.error(<span class="string">"Environment variable LANG is '"</span> + System.getenv(<span class="string">"LANG"</span>)</span><br><span class="line">                    + <span class="string">"'. You could use a locale setting that matches encoding='"</span></span><br><span class="line">                    + desired + <span class="string">"'."</span>);</span><br><span class="line">            logger.error(<span class="string">"Environment variable LC_ALL is '"</span> + System.getenv(<span class="string">"LC_ALL"</span>)</span><br><span class="line">                    + <span class="string">"'. You could use a locale setting that matches encoding='"</span></span><br><span class="line">                    + desired + <span class="string">"'."</span>);</span><br><span class="line">            <span class="comment">// æŠ›å‡º IllegalStateException å¼‚å¸¸</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                    <span class="string">"The Java Virtual Machine has not been configured to use the "</span></span><br><span class="line">                            + <span class="string">"desired default character encoding ("</span> + desired + <span class="string">")."</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="13-LiquibaseServiceLocatorApplicationListener"><a href="#13-LiquibaseServiceLocatorApplicationListener" class="headerlink" title="13. LiquibaseServiceLocatorApplicationListener"></a>13. LiquibaseServiceLocatorApplicationListener</h1><p><code>org.springframework.boot.liquibase.LiquibaseServiceLocatorApplicationListener</code> ï¼Œå®ç° ApplicationListener æ¥å£ï¼Œåˆå§‹åŒ– Liquibase çš„ ServiceLocator å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>å¦‚æœä¸äº†è§£ Liquibase çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ <a href="http://www.iocoder.cn/Spring-Boot/battcn/v2-other-liquibase/?vip" rel="external nofollow noopener noreferrer" target="_blank">ã€Šä¸€èµ·æ¥å­¦ SpringBoot 2.x | ç¬¬äºŒåå››ç¯‡ï¼šæ•°æ®åº“ç®¡ç†ä¸è¿ç§»ï¼ˆLiquibaseï¼‰ã€‹</a> æ–‡ç« ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// LiquibaseServiceLocatorApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LiquibaseServiceLocatorApplicationListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">ApplicationStartingEvent</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(LiquibaseServiceLocatorApplicationListener.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ApplicationStartingEvent event)</span> </span>{</span><br><span class="line">        <span class="comment">// &lt;1&gt; å¦‚æœå­˜åœ¨ CustomResolverServiceLocator ç±»</span></span><br><span class="line">        <span class="keyword">if</span> (ClassUtils.isPresent(<span class="string">"liquibase.servicelocator.CustomResolverServiceLocator"</span>,</span><br><span class="line">                event.getSpringApplication().getClassLoader())) {</span><br><span class="line">            <span class="keyword">new</span> LiquibasePresent().replaceServiceLocator();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Inner class to prevent class not found issues.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LiquibasePresent</span> </span>{</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">replaceServiceLocator</span><span class="params">()</span> </span>{</span><br><span class="line">            <span class="comment">// &lt;2&gt; åˆ›å»º CustomResolverServiceLocator å¯¹è±¡</span></span><br><span class="line">            CustomResolverServiceLocator customResolverServiceLocator = <span class="keyword">new</span> CustomResolverServiceLocator(<span class="keyword">new</span> SpringPackageScanClassResolver(logger));</span><br><span class="line">            <span class="comment">// è®¾ç½® ServiceLocator çš„ `instance` å±æ€§</span></span><br><span class="line">            ServiceLocator.setInstance(customResolverServiceLocator);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨ <code>liquibase.servicelocator.CustomResolverServiceLocator</code> ç±»ã€‚é€šè¿‡è¯¥åˆ¤æ–­ï¼Œå¯ä»¥çŸ¥é“æ˜¯å¦å¼•å…¥äº† <code>liquibase-core</code> åŒ…ï¼Œéœ€è¦ä½¿åˆå§‹åŒ– Liquibase åŠŸèƒ½ã€‚</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œåˆ›å»º CustomResolverServiceLocator å¯¹è±¡ã€‚å½“ç„¶ï¼Œå¦‚æœæ²¡æœ‰è‡ªå®šä¹‰çš„è¯ï¼Œè¿™ä¸ªå¯¹è±¡ï¼Œè¿”å›çš„å°±æ˜¯é»˜è®¤çš„ Liquibase ServiceLocator å¯¹è±¡ã€‚</li>
<li><code>&lt;3&gt;</code> å¤„ï¼Œè®¾ç½®åˆ° ServiceLocator çš„ <code>instance</code> å±æ€§ã€‚</li>
</ul>
<p>å½“ç„¶ï¼Œä»¥ä¸Šçš„é€»è¾‘ï¼Œèƒ–å‹é€‰æ‹©æ€§äº†è§£å³å¯ã€‚å“ˆå“ˆå“ˆå“ˆ~</p>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ä¸¥æ ¼æ¥è¯´ï¼Œæœ¬æ–‡å¹¶æ²¡æœ‰å†™å¤ªå¤šå…·ä½“çš„å†…å®¹ã€‚æ›´å¤šçš„æ˜¯ï¼Œä¸ºäº†åé¢çš„å†…å®¹åšä¸€ä¸ªé“ºå«ï¼ŒåŒæ—¶ä¹Ÿè®©èƒ–å‹çŸ¥é“ï¼ŒSpring Boot é»˜è®¤æä¾›çš„ ApplicationListener å®ç°ç±»ã€‚</p>
<p>å‚è€ƒå’Œæ¨èå¦‚ä¸‹æ–‡ç« ï¼š</p>
<ul>
<li>oldflame-Jm <a href="https://blog.csdn.net/jamet/article/details/78042486" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Boot æºç åˆ†æ - ApplicationListener åº”ç”¨ç¯å¢ƒï¼ˆ5ï¼‰ã€‹</a></li>
</ul>




</div>